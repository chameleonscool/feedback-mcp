# 飞书多租户功能需求文档 (PRD)

## 1. 概述

### 1.1 背景

User Intent MCP 是一个 AI 反馈系统，允许 AI Agent 在执行过程中向用户发送消息并收集用户反馈。当前系统支持 Web UI 和单用户飞书模式，但存在以下限制：

- 飞书模式只支持单用户，需要手动配置 receive_id
- 管理配置（App ID/Secret）和用户配置混在一起
- 不支持多用户独立使用

### 1.2 目标

实现飞书多租户功能，支持：
1. 管理员后台配置飞书应用凭证
2. 用户通过飞书 OAuth 登录
3. 每个用户获得独立的 API Key
4. AI Agent 通过 API Key 自动识别用户并发送消息

### 1.3 范围

- **包含**：飞书 OAuth 登录、用户管理、API Key 认证、消息路由、用户级消息隔离
- **不包含**：群聊支持、企业级多租户隔离（按 tenant_key）、ISV 模式

### 1.4 隔离级别说明

本系统支持两种隔离级别：

| 隔离级别 | 说明 | 状态 |
|---------|------|------|
| **用户级隔离** | 同一系统内，不同用户的消息互不可见。用户 A 只能看到发给自己的消息，用户 B 只能看到发给自己的消息。 | ✅ 已实现 |
| **企业级隔离** | 不同企业/组织的数据完全隔离，企业 A 的用户看不到企业 B 的任何数据。通常用于 SaaS 产品支持多个企业客户。 | 📋 v2.0 计划 |

当前版本实现的是**用户级隔离**，适用于单一组织内多用户使用的场景。

---

## 2. 用户故事

### 2.1 管理员故事

#### US-001: 首次配置系统 ✅ 已完成
**作为** 系统管理员  
**我想要** 在首次部署后配置飞书应用凭证  
**以便** 启用飞书登录和消息功能

**验收标准**：
- [x] 首次访问时显示初始化设置页面
- [x] 可以设置管理员用户名和密码
- [x] 可以配置飞书 App ID 和 App Secret
- [x] 可以配置 OAuth 回调 URL
- [x] 配置保存后跳转到管理后台

#### US-002: 管理系统配置 ✅ 已完成
**作为** 系统管理员  
**我想要** 在管理后台修改系统配置  
**以便** 更新飞书应用凭证或其他设置

**验收标准**：
- [x] 通过用户名和密码验证访问管理后台
- [x] 可以查看和修改飞书配置
- [x] 可以查看已注册用户列表
- [x] 可以禁用/启用用户

---

### 2.2 用户故事

#### US-003: 飞书 OAuth 登录 ✅ 已完成
**作为** 普通用户  
**我想要** 使用飞书账号登录系统  
**以便** 无需手动配置即可使用 AI 反馈功能

**验收标准**：
- [x] 登录页面显示"飞书登录"按钮
- [x] 点击后跳转到飞书授权页面
- [x] 授权成功后自动创建用户账号
- [x] 登录成功后显示用户信息和 API Key

#### US-004: 获取 API Key ✅ 已完成
**作为** 已登录用户  
**我想要** 查看和复制我的 API Key  
**以便** 配置到 MCP 客户端中使用

**验收标准**：
- [x] 登录后在个人中心显示 API Key
- [x] 提供一键复制功能
- [x] 显示 MCP 配置示例
- [ ] 可以重新生成 API Key（API 已实现，UI 待完善）

#### US-005: 接收 AI 消息 ✅ 已完成
**作为** 已配置 API Key 的用户  
**我想要** 在飞书中接收 AI 发送的消息  
**以便** 随时随地查看 AI 的问题并回复

**验收标准**：
- [x] AI 调用 collect_user_intent 时，消息发送到用户的飞书
- [x] 消息包含问题内容
- [x] 用户可以直接在飞书中回复
- [x] 通过 WebSocket 长连接接收飞书回复

#### US-006: 在 Web UI 回复 ✅ 已完成
**作为** 已登录用户  
**我想要** 在 Web UI 中查看和回复 AI 的问题  
**以便** 在电脑上更方便地处理复杂问题

**验收标准**：
- [x] Web UI 显示当前用户的待处理问题
- [x] 可以输入文字和上传图片回复
- [x] 回复后 AI 能收到响应
- [x] 显示用户登录状态和头像

#### US-009: 消息用户隔离 ✅ 已完成
**作为** 已登录用户  
**我想要** 只看到发送给我的消息  
**以便** 不会看到其他用户的消息，保护隐私

**验收标准**：
- [x] 飞书登录用户只能看到自己的消息
- [x] 无登录 WebUI 用户只能看到公共消息（未绑定用户的消息）
- [x] 用户 A 无法回复用户 B 的消息
- [x] 消息队列按 user_id 隔离

#### US-010: 单用户模式兼容 ✅ 已完成
**作为** 不使用飞书登录的用户  
**我想要** 通过无登录 WebUI 使用系统  
**以便** 在简单场景下快速使用

**验收标准**：
- [x] 无登录 WebUI 可以正常访问
- [x] 无登录模式下只能看到 user_id 为空的消息
- [x] MCP 工具未配置 API Key 时，消息不绑定用户
- [x] 飞书用户和无登录用户的消息完全隔离

#### US-011: 飞书通知开关 ✅ 已完成
**作为** 已登录用户  
**我想要** 控制是否接收飞书消息通知  
**以便** 在不需要时关闭通知

**验收标准**：
- [x] WebUI 中显示飞书通知开关
- [x] 开关状态与用户绑定
- [x] 关闭通知后不再发送飞书消息
- [x] 开关状态持久化存储

---

### 2.3 AI Agent 故事

#### US-007: 通过 API Key 认证 ✅ 已完成
**作为** AI Agent  
**我想要** 通过 API Key 自动识别目标用户  
**以便** 无需在每次调用时指定用户 ID

**验收标准**：
- [x] MCP 服务端通过环境变量读取 API Key
- [x] 根据 API Key 查找对应用户
- [x] 消息自动发送给该用户

#### US-008: 收集用户反馈 ✅ 已完成
**作为** AI Agent  
**我想要** 调用 collect_user_intent 并等待用户回复  
**以便** 根据用户反馈继续执行任务

**验收标准**：
- [x] 调用工具后消息发送到用户
- [x] 等待用户在飞书或 Web UI 回复
- [x] 收到回复后返回给 AI
- [x] 超时后返回超时提示

---

## 3. 功能需求

### 3.1 管理后台

| 功能 | 描述 | 优先级 | 状态 |
|------|------|--------|------|
| 初始化设置 | 首次部署时设置管理员密码和飞书配置 | P0 | ✅ 完成 |
| 配置管理 | 查看和修改飞书应用凭证 | P0 | ✅ 完成 |
| 用户管理 | 查看用户列表、禁用用户 | P1 | ✅ 完成 |
| WebSocket 状态 | 查看飞书 WebSocket 连接状态 | P2 | ✅ 完成 |

### 3.2 用户认证

| 功能 | 描述 | 优先级 | 状态 |
|------|------|--------|------|
| 飞书 OAuth 登录 | 通过飞书授权登录系统 | P0 | ✅ 完成 |
| 会话管理 | 登录状态保持、自动过期 | P0 | ✅ 完成 |
| API Key 管理 | 查看、复制、重新生成 API Key | P0 | ✅ 完成 |

### 3.3 消息功能

| 功能 | 描述 | 优先级 | 状态 |
|------|------|--------|------|
| 飞书消息发送 | 根据 API Key 发送消息到用户飞书 | P0 | ✅ 完成 |
| 飞书消息接收 | 通过 WebSocket 长连接接收用户回复 | P0 | ✅ 完成 |
| Web UI 回复 | 用户在 Web UI 中回复问题 | P0 | ✅ 完成 |
| 消息用户隔离 | 消息按用户 ID 隔离 | P0 | ✅ 完成 |
| 飞书通知开关 | 用户可控制是否接收飞书通知 | P1 | ✅ 完成 |
| 多端同步 | 飞书和 Web UI 回复同步 | P1 | ✅ 完成 |

### 3.4 消息路由规则

| 场景 | MCP 配置 | 消息 user_id | WebUI 可见性 |
|------|----------|-------------|-------------|
| 飞书用户 A | API_KEY=uk_A | user_id=ou_A | 只有用户 A 可见 |
| 飞书用户 B | API_KEY=uk_B | user_id=ou_B | 只有用户 B 可见 |
| 无登录模式 | 未配置 API_KEY | user_id=NULL | 只有无登录 WebUI 可见 |
| 混合场景 | - | - | 严格隔离，互不可见 |

---

## 4. 非功能需求

### 4.1 安全性
- [x] 管理员密码使用 PBKDF2-SHA256 加密存储
- [x] API Key 使用安全随机数生成（uk_ 前缀）
- [x] OAuth 回调验证 state 参数防止 CSRF
- [x] 管理员会话持久化到数据库

### 4.2 性能
- [x] 消息发送响应时间 < 2s
- [x] 支持同时在线用户 > 100
- [x] WebSocket 长连接自动重连

### 4.3 兼容性
- [x] 保持与现有单用户模式的兼容
- [x] API Key 未配置时降级到 Web UI 模式
- [x] 单一入口启动所有服务

### 4.4 部署
- [x] 支持 systemd 部署
- [x] 支持 Docker 部署
- [x] 支持 Nginx 反向代理
- [x] 提供详细部署文档

---

## 5. 界面原型

### 5.1 登录页面

![登录页面](diagrams/ui-login.svg)

**页面说明**：
- 居中显示的卡片式设计
- 提供飞书登录和 Web UI 两种入口
- 简洁的视觉引导

### 5.2 初始化设置页面（首次部署）

![初始化设置](diagrams/ui-init-setup.svg)

**页面说明**：
- 分步骤引导完成初始化
- 第一步：设置管理员用户名和密码
- 第二步：配置飞书应用
- 第三步：完成设置

### 5.3 用户中心（登录后）

![用户中心](diagrams/ui-user-center.svg)

**页面说明**：
- 显示用户信息和头像
- API Key 显示和复制功能
- MCP 配置示例代码
- 进入 WebUI 按钮
- 飞书连接状态指示

### 5.4 管理后台

![管理后台](diagrams/ui-admin.svg)

**页面说明**：
- 左侧导航菜单
- 飞书应用配置表单
- 管理员密码修改
- 系统状态监控
- WebSocket 状态显示

### 5.5 WebUI 界面

**已实现功能**：
- 用户信息显示（头像、名称、登录状态）
- 飞书通知开关
- 待处理任务列表
- 回复输入框（支持文字和图片）
- Service Worker 状态
- 返回登录按钮

---

## 6. 版本计划

### v1.0 - MVP ✅ 已完成
- [x] 管理员初始化设置
- [x] 飞书 OAuth 登录
- [x] API Key 认证
- [x] 基本消息功能
- [x] 消息用户隔离
- [x] WebSocket 长连接接收消息
- [x] 飞书通知开关

### v1.1 - 增强（计划中）
- [ ] 消息历史查看
- [ ] 批量消息管理
- [ ] 用户设置页面优化

### v2.0 - 扩展（计划中）
- [ ] 群聊支持
- [ ] 企业级多租户隔离（按 tenant_key，支持多企业 SaaS 部署）
- [ ] 更多飞书功能集成
