<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Intent Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
            border-left: 3px solid #8b5cf6;
        }
        
        .sidebar-item {
            border-left: 3px solid transparent;
        }
        
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Markdown Styles */
        .markdown-content {
            line-height: 1.6;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            font-weight: 600;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        .markdown-content h1 { font-size: 1.5em; }
        .markdown-content h2 { font-size: 1.25em; }
        .markdown-content h3 { font-size: 1.1em; }
        .markdown-content p { margin-bottom: 0.75em; }
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        .markdown-content li { margin-bottom: 0.25em; }
        .markdown-content code {
            background: #f1f5f9;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: ui-monospace, monospace;
        }
        .markdown-content pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 0.75em;
        }
        .markdown-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }
        .markdown-content blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1em;
            color: #64748b;
            margin-bottom: 0.75em;
        }
        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 0.75em;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #e2e8f0;
            padding: 0.5em;
            text-align: left;
        }
        .markdown-content th {
            background: #f8fafc;
            font-weight: 600;
        }
    </style>
</head>

<body class="bg-slate-50 text-gray-800 h-screen flex overflow-hidden">

    <!-- Sidebar - ç°ä»£æ·±è‰²è®¾è®¡ -->
    <aside class="w-80 bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900 flex flex-col shadow-2xl z-10">
        <!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
        <div class="p-5 border-b border-slate-700/50">
            <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
            <div id="user-info" class="flex items-center gap-3 p-3 bg-slate-800/50 rounded-2xl border border-slate-700/30 backdrop-blur">
                <div id="user-avatar" class="w-12 h-12 rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-violet-500/30 ring-2 ring-slate-700">
                    ğŸ‘¤
                </div>
                <div class="flex-1 min-w-0">
                    <div id="user-name" class="font-semibold text-white truncate">Loading...</div>
                    <div class="flex items-center gap-1.5 mt-1">
                        <span id="user-status-dot" class="w-2 h-2 rounded-full bg-slate-500"></span>
                        <span id="user-status" class="text-xs text-slate-400">Checking...</span>
                    </div>
                </div>
                <button onclick="toggleLang()"
                    class="p-2 text-xs font-medium text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-all"
                    id="lang-btn">
                    ä¸­æ–‡
                </button>
            </div>
            
            <!-- çŠ¶æ€æŒ‡ç¤ºå™¨å’Œé£ä¹¦å¼€å…³ -->
            <div class="mt-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="relative flex h-2.5 w-2.5">
                        <span id="status-ping" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span id="status-dot" class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span>
                    </span>
                    <span id="status-text" class="text-xs text-slate-400 font-medium">Service Connected</span>
                </div>
                
                <!-- é£ä¹¦é€šçŸ¥å¼€å…³ -->
                <div id="feishu-toggle-container" class="hidden">
                    <button id="feishu-toggle-btn" onclick="toggleFeishuNotify()"
                        class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium transition-all">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <span id="feishu-toggle-text">é£ä¹¦é€šçŸ¥</span>
                    </button>
                </div>
            </div>
            
            <!-- æ ‡é¢˜ -->
            <div class="mt-4 flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                        </path>
                    </svg>
                </div>
                <h1 class="text-lg font-bold text-white" id="ui-title">AI Intent</h1>
            </div>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨åŒºåŸŸ -->
        <div class="flex-1 overflow-y-auto p-4 space-y-3">
            <!-- å¾…å¤„ç†ä»»åŠ¡æ ‡é¢˜ -->
            <div class="flex items-center gap-2 px-1 mb-2">
                <div class="w-1.5 h-1.5 rounded-full bg-amber-400 animate-pulse"></div>
                <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Pending Tasks</span>
            </div>
            
            <!-- Pending Tasks -->
            <div id="task-list" class="space-y-2">
                <!-- Task items will be injected here -->
            </div>
            
            <!-- History Section -->
            <div id="history-section" class="hidden mt-6 pt-4 border-t border-slate-700/50">
                <div class="flex items-center justify-between mb-3 px-1">
                    <span id="history-title" class="text-xs font-semibold text-slate-500 uppercase tracking-wider">History</span>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleSelectAll()" class="text-[10px] text-slate-500 hover:text-slate-300 hidden transition-colors" id="select-all-btn">
                            <span id="select-all-text">All</span>
                        </button>
                        <button onclick="deleteSelectedHistory()" class="text-[10px] text-rose-400 hover:text-rose-300 hidden transition-colors" id="delete-history-btn">
                            <span id="delete-btn-text">Delete</span>
                        </button>
                        <button onclick="toggleHistory()" class="text-[10px] text-slate-500 hover:text-slate-300 transition-colors" id="toggle-history-btn">
                            <span id="history-toggle-text">Hide</span>
                        </button>
                    </div>
                </div>
                <div id="history-list" class="space-y-2">
                    <!-- History items will be injected here -->
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å·¥å…·æ  -->
        <div class="p-4 border-t border-slate-700/50 bg-slate-900/50">
            <div class="flex items-center justify-between">
                <button id="notify-btn" onclick="requestNotificationPermission()"
                    class="text-xs text-slate-500 hover:text-slate-300 transition-colors flex items-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                        </path>
                    </svg>
                    <span id="notify-status">Checking...</span>
                </button>
                <div id="sw-status" class="text-[10px] text-slate-600">SW: Loading</div>
            </div>
            
            <!-- è¿”å›ç™»å½•æŒ‰é’® -->
            <a href="/"
                class="mt-3 w-full flex items-center justify-center gap-2 px-4 py-2.5 text-sm text-slate-400 hover:text-white hover:bg-slate-700/50 rounded-xl transition-all">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1">
                    </path>
                </svg>
                <span id="ui-back-login">Back to Login</span>
            </a>
        </div>
    </aside>

    <!-- Main Content - ç°ä»£åŒ–è®¾è®¡ -->
    <main class="flex-1 flex flex-col relative bg-gradient-to-br from-slate-50 via-white to-blue-50/30">
        <!-- è£…é¥°æ€§èƒŒæ™¯ -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute -top-40 -right-40 w-80 h-80 bg-gradient-to-br from-violet-200/30 to-purple-200/30 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-gradient-to-br from-blue-200/30 to-cyan-200/30 rounded-full blur-3xl"></div>
        </div>

        <div class="flex-1 overflow-y-auto p-8 relative z-0 flex items-start justify-center" id="main-view">
            <!-- Detail View will be injected here -->
        </div>
    </main>

    <script>
        // --- i18n ---
        const translations = {
            en: {
                title: "AI Intent",
                status_connected: "Service Connected",
                status_disconnected: "Disconnected (Retrying...)",
                no_tasks: "No pending tasks",
                notify_label: "Notification:",
                notify_checking: "Checking...",
                notify_granted: "On",
                notify_denied: "Off",
                notify_default: "Request",
                sw_active: "SW: Active",
                sw_loading: "SW: Loading",
                sw_failed: "SW: Failed",
                all_done: "All tasks completed",
                wait_ai: "Waiting for AI to ask questions...",
                no_task_selected: "No task selected",
                select_task_tip: "Select a task from the list to reply",
                ticket: "Ticket",
                just_now: "just now",
                placeholder: "Enter your reply... (Ctrl+Enter to send)",
                markdown_tip: "Supports Markdown | âŒ˜+Enter",
                upload_img: "Click to upload screenshot",
                paste_tip: "Or paste image directly",
                dismiss: "Dismiss",
                send: "Send Reply",
                alert_empty: "Please enter content or upload an image",
                alert_fail: "Send failed",
                alert_op_fail: "Operation failed",
                status_pending: "Pending",
                new_msg_notify: "New AI Intent Request",
                history: "History",
                history_hide: "Hide",
                history_show: "Show",
                completed: "Completed",
                delete_selected: "Delete",
                select_all: "All",
                deselect_all: "None",
                back_login: "Back to Login",
                user_logged_in: "Logged in",
                user_not_logged_in: "Not logged in",
                user_guest_mode: "Guest Mode",
                user_loading: "Loading..."
            },
            zh: {
                title: "AI æ„å›¾é‡‡é›†ä¸­å¿ƒ",
                status_connected: "æœåŠ¡è¿æ¥æ­£å¸¸",
                status_disconnected: "è¿æ¥æ–­å¼€ (é‡è¯•ä¸­...)",
                no_tasks: "æš‚æ— å¾…å¤„ç†ä»»åŠ¡",
                notify_label: "é€šçŸ¥æƒé™:",
                notify_checking: "æ£€æŸ¥ä¸­...",
                notify_granted: "å·²å¼€å¯",
                notify_denied: "å·²ç¦ç”¨",
                notify_default: "ç‚¹å‡»è¯·æ±‚",
                sw_active: "SW: å·²æ¿€æ´»",
                sw_loading: "SW: æœªåŠ è½½",
                sw_failed: "SW: å¤±è´¥",
                all_done: "å·²å®Œæˆæ‰€æœ‰ä»»åŠ¡",
                wait_ai: "è¯·ç­‰å¾… AI å‘èµ·æ–°çš„æé—®...",
                no_task_selected: "æ²¡æœ‰é€‰ä¸­çš„ä»»åŠ¡",
                select_task_tip: "è¯·ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªä»»åŠ¡è¿›è¡Œå›å¤",
                ticket: "ä»»åŠ¡",
                just_now: "åˆšåˆš",
                placeholder: "è¯·è¾“å…¥æ‚¨çš„å›å¤... (Ctrl+Enter å‘é€)",
                markdown_tip: "æ”¯æŒ Markdown | âŒ˜+Enter",
                upload_img: "ç‚¹å‡»ä¸Šä¼ æˆªå›¾",
                paste_tip: "æˆ–ç›´æ¥ç²˜è´´å›¾ç‰‡åˆ°é¡µé¢",
                dismiss: "å¿½ç•¥ (Dismiss)",
                send: "å‘é€å›å¤",
                alert_empty: "è¯·è¾“å…¥å†…å®¹æˆ–ä¸Šä¼ å›¾ç‰‡",
                alert_fail: "å‘é€å¤±è´¥",
                alert_op_fail: "æ“ä½œå¤±è´¥",
                status_pending: "å¤„ç†ä¸­",
                new_msg_notify: "AI æ–°æ„å›¾è¯·æ±‚",
                history: "å†å²è®°å½•",
                history_hide: "éšè—",
                history_show: "æ˜¾ç¤º",
                completed: "å·²å®Œæˆ",
                delete_selected: "åˆ é™¤",
                select_all: "å…¨é€‰",
                deselect_all: "å–æ¶ˆ",
                back_login: "è¿”å›ç™»å½•",
                user_logged_in: "å·²ç™»å½•",
                user_not_logged_in: "æœªç™»å½•",
                user_guest_mode: "è®¿å®¢æ¨¡å¼",
                user_loading: "åŠ è½½ä¸­..."
            }
        };

        let currentLang = localStorage.getItem('lang') || 'en';

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function toggleLang() {
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            localStorage.setItem('lang', currentLang);
            applyLang();
            renderSidebar();
            renderMain();
        }

        function applyLang() {
            document.documentElement.lang = currentLang === 'en' ? 'en' : 'zh-CN';
            document.title = t('title');
            document.getElementById('ui-title').innerText = t('title');
            document.getElementById('ui-back-login').innerText = t('back_login');
            document.getElementById('lang-btn').innerText = currentLang === 'en' ? 'ä¸­æ–‡' : 'English';

            // Update status text based on current state
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            if (statusDot && statusDot.classList.contains('bg-emerald-500')) {
                statusText.innerText = t('status_connected');
            } else if (statusText) {
                statusText.innerText = t('status_disconnected');
            }

            updateNotifyStatus();
            updateSWStatus();
        }

        let tasks = [];
        let history = [];
        let historyVisible = true;
        let selectedTaskId = null;
        let selectedHistoryId = null;
        let imageCache = {};
        let textCache = {};
        let selectedHistoryIds = new Set();  // For multi-select delete
        
        // ä» URL è·å– api_keyï¼ˆç”¨äºæ¶ˆæ¯éš”ç¦»ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const apiKey = urlParams.get('api_key');
        
        // ç”¨æˆ·ä¿¡æ¯
        let currentUser = null;
        let feishuNotifyEnabled = false;  // é£ä¹¦é€šçŸ¥å¼€å…³çŠ¶æ€
        
        // API è¯·æ±‚è¾…åŠ©å‡½æ•° - ä½¿ç”¨ Authorization Header
        async function apiRequest(url, options = {}) {
            const headers = options.headers || {};
            if (apiKey) {
                headers['Authorization'] = `Bearer ${apiKey}`;
            }
            return fetch(url, { ...options, headers });
        }
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        async function fetchUserInfo() {
            const userNameEl = document.getElementById('user-name');
            const userStatusEl = document.getElementById('user-status');
            const userStatusDotEl = document.getElementById('user-status-dot');
            const userAvatarEl = document.getElementById('user-avatar');
            const feishuToggleContainer = document.getElementById('feishu-toggle-container');
            
            if (!apiKey) {
                // æ— ç™»å½•æ¨¡å¼ - è®¿å®¢æ ·å¼
                currentUser = null;
                userNameEl.innerText = t('user_guest_mode');
                userStatusEl.innerText = t('user_not_logged_in');
                userStatusEl.classList.remove('text-emerald-400');
                userStatusEl.classList.add('text-slate-500');
                userStatusDotEl.classList.remove('bg-emerald-500');
                userStatusDotEl.classList.add('bg-slate-500');
                userAvatarEl.innerHTML = 'ğŸ‘¤';
                userAvatarEl.className = 'w-12 h-12 rounded-xl bg-gradient-to-br from-slate-600 to-slate-700 flex items-center justify-center text-white font-bold text-lg shadow-lg ring-2 ring-slate-700';
                feishuToggleContainer.classList.add('hidden');
                return;
            }
            
            try {
                const response = await apiRequest('/api/user/info');
                if (response.ok) {
                    currentUser = await response.json();
                    userNameEl.innerText = currentUser.name || 'User';
                    userStatusEl.innerText = t('user_logged_in');
                    userStatusEl.classList.remove('text-slate-500');
                    userStatusEl.classList.add('text-emerald-400');
                    userStatusDotEl.classList.remove('bg-slate-500');
                    userStatusDotEl.classList.add('bg-emerald-500');
                    
                    // æ˜¾ç¤ºé£ä¹¦é€šçŸ¥å¼€å…³ï¼ˆç™»å½•ç”¨æˆ·å¯ç”¨ï¼‰
                    feishuToggleContainer.classList.remove('hidden');
                    await loadFeishuNotifyStatus();
                    
                    // æ˜¾ç¤ºå¤´åƒæˆ–é¦–å­—æ¯
                    if (currentUser.avatar_url) {
                        userAvatarEl.innerHTML = `<img src="${currentUser.avatar_url}" class="w-12 h-12 rounded-xl object-cover" alt="avatar" />`;
                        userAvatarEl.className = 'w-12 h-12 rounded-xl shadow-lg ring-2 ring-slate-700 overflow-hidden';
                    } else {
                        const initial = (currentUser.name || 'U').charAt(0).toUpperCase();
                        userAvatarEl.innerHTML = initial;
                        userAvatarEl.className = 'w-12 h-12 rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-violet-500/30 ring-2 ring-slate-700';
                    }
                } else {
                    // API Key æ— æ•ˆ - è®¿å®¢æ ·å¼
                    currentUser = null;
                    userNameEl.innerText = t('user_guest_mode');
                    userStatusEl.innerText = t('user_not_logged_in');
                    userStatusEl.classList.remove('text-emerald-400');
                    userStatusEl.classList.add('text-slate-500');
                    userStatusDotEl.classList.remove('bg-emerald-500');
                    userStatusDotEl.classList.add('bg-slate-500');
                    userAvatarEl.innerHTML = 'ğŸ‘¤';
                    userAvatarEl.className = 'w-12 h-12 rounded-xl bg-gradient-to-br from-slate-600 to-slate-700 flex items-center justify-center text-white font-bold text-lg shadow-lg ring-2 ring-slate-700';
                    feishuToggleContainer.classList.add('hidden');
                }
            } catch (e) {
                console.error('Failed to fetch user info:', e);
                userNameEl.innerText = t('user_guest_mode');
                userStatusEl.innerText = t('user_not_logged_in');
            }
        }
        
        // åŠ è½½é£ä¹¦é€šçŸ¥çŠ¶æ€
        async function loadFeishuNotifyStatus() {
            if (!apiKey) return;
            try {
                const response = await apiRequest('/api/user/feishu-notify');
                if (response.ok) {
                    const data = await response.json();
                    feishuNotifyEnabled = data.enabled;
                    updateFeishuToggleUI();
                }
            } catch (e) {
                console.error('Failed to load feishu notify status:', e);
            }
        }
        
        // åˆ‡æ¢é£ä¹¦é€šçŸ¥
        async function toggleFeishuNotify() {
            if (!apiKey) return;
            try {
                const response = await apiRequest('/api/user/feishu-notify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: !feishuNotifyEnabled })
                });
                if (response.ok) {
                    feishuNotifyEnabled = !feishuNotifyEnabled;
                    updateFeishuToggleUI();
                }
            } catch (e) {
                console.error('Failed to toggle feishu notify:', e);
            }
        }
        
        // æ›´æ–°é£ä¹¦å¼€å…³ UI
        function updateFeishuToggleUI() {
            const btn = document.getElementById('feishu-toggle-btn');
            const text = document.getElementById('feishu-toggle-text');
            if (feishuNotifyEnabled) {
                btn.className = 'flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium transition-all bg-emerald-500/20 text-emerald-400 border border-emerald-500/30';
                text.innerText = 'é£ä¹¦é€šçŸ¥ ON';
            } else {
                btn.className = 'flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium transition-all bg-slate-700/50 text-slate-400 border border-slate-600/30 hover:bg-slate-700';
                text.innerText = 'é£ä¹¦é€šçŸ¥ OFF';
            }
        }

        // --- Notification ---
        function updateNotifyStatus() {
            const status = Notification.permission;
            const el = document.getElementById('notify-status');
            if (!el) return;

            if (status === 'granted') {
                el.innerText = t('notify_granted');
                el.className = 'text-green-500 font-bold';
            } else if (status === 'denied') {
                el.innerText = t('notify_denied');
                el.className = 'text-red-500 font-bold';
            } else {
                el.innerText = t('notify_default');
                el.className = '';
            }
        }

        function updateSWStatus() {
            const el = document.getElementById('sw-status');
            if (!el) return;
            if (swRegistration) {
                el.innerText = t('sw_active');
                el.className = 'text-[10px] text-green-400';
            } else {
                // If it's already failed, keep failed.
            }
        }

        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                updateNotifyStatus();
                if (permission === 'granted') {
                    new Notification(t('title'), { body: t('notify_granted') });
                }
            });
        }

        // --- Service Worker Registration ---
        let swRegistration = null;
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(reg => {
                swRegistration = reg;
                updateSWStatus();
            }).catch(err => {
                const el = document.getElementById('sw-status');
                if (el) {
                    el.innerText = t('sw_failed');
                    el.className = 'text-[10px] text-red-400';
                }
            });

            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data.type === 'SELECT_TASK') {
                    selectTask(event.data.id);
                }
            });
        }

        function sendNotification(id, msg) {
            if (Notification.permission === "granted") {
                if (swRegistration) {
                    swRegistration.showNotification(t('new_msg_notify'), {
                        body: msg,
                        tag: id,
                        icon: '/favicon.ico'
                    });
                } else {
                    const n = new Notification(t('new_msg_notify'), {
                        body: msg,
                        tag: id,
                        icon: '/favicon.ico'
                    });
                    n.onclick = function (e) {
                        e.preventDefault();
                        window.focus();
                        selectTask(id);
                    };
                }
            }
        }

        // --- API & State ---
        async function poll() {
            try {
                // ä½¿ç”¨ Authorization Header å®ç°æ¶ˆæ¯éš”ç¦»
                const response = await apiRequest('/api/poll');
                const newTasks = await response.json();

                const oldIds = new Set(tasks.map(t => t.id));
                newTasks.forEach(task => {
                    if (!oldIds.has(task.id)) {
                        sendNotification(task.id, task.question);
                    }
                });

                const isChanged = JSON.stringify(tasks.map(t => t.id)) !== JSON.stringify(newTasks.map(t => t.id));
                tasks = newTasks;

                if (tasks.length > 0) {
                    if (!selectedTaskId || !tasks.find(t => t.id === selectedTaskId)) {
                        const hash = window.location.hash.substring(1);
                        if (hash && tasks.find(t => t.id === hash)) {
                            selectedTaskId = hash;
                            selectedHistoryId = null;  // Clear history selection when auto-selecting task
                        } else {
                            if (!selectedTaskId && !selectedHistoryId) {
                                // Only auto-select first task if no history is selected
                                selectedTaskId = tasks[0].id;
                            }
                        }
                        if (selectedTaskId && !selectedHistoryId) {
                            renderMain();
                        }
                    }
                } else {
                    if (selectedTaskId !== null) {
                        saveCurrentText();
                        selectedTaskId = null;
                        renderMain();
                    }
                }

                if (isChanged) renderSidebar();
                document.getElementById('status-dot').classList.replace('bg-red-500', 'bg-green-500');
                document.getElementById('status-text').innerText = t('status_connected');

            } catch (e) {
                document.getElementById('status-dot').classList.replace('bg-green-500', 'bg-red-500');
                document.getElementById('status-text').innerText = t('status_disconnected');
            }
        }

        async function fetchHistory() {
            try {
                const response = await fetch('/api/history');
                const newHistory = await response.json();
                const isChanged = JSON.stringify(history.map(h => h.id)) !== JSON.stringify(newHistory.map(h => h.id));
                history = newHistory;
                if (isChanged) renderHistory();
            } catch (e) {
                // Silently fail - history is optional
            }
        }

        function selectTask(id) {
            if (selectedTaskId === id) return;
            saveCurrentText();
            selectedTaskId = id;
            selectedHistoryId = null;
            window.location.hash = id;
            renderSidebar();
            renderHistory();
            renderMain();
        }

        function selectHistoryItem(id) {
            if (selectedHistoryId === id) return;
            saveCurrentText();
            selectedHistoryId = id;
            selectedTaskId = null;
            window.location.hash = id;
            renderSidebar();
            renderHistory();
            renderMain();
        }

        function toggleHistory() {
            historyVisible = !historyVisible;
            const historyList = document.getElementById('history-list');
            const toggleText = document.getElementById('history-toggle-text');
            if (historyVisible) {
                historyList.classList.remove('hidden');
                toggleText.innerText = t('history_hide');
            } else {
                historyList.classList.add('hidden');
                toggleText.innerText = t('history_show');
            }
        }

        // --- Rendering ---
        function renderSidebar() {
            const container = document.getElementById('task-list');

            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 px-4">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-slate-700/50 flex items-center justify-center">
                            <svg class="w-8 h-8 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                            </svg>
                        </div>
                        <p class="text-slate-500 text-sm font-medium">${t('no_tasks')}</p>
                        <p class="text-slate-600 text-xs mt-1">${t('wait_ai')}</p>
                    </div>`;
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div onclick="selectTask('${task.id}')" 
                     class="sidebar-item p-4 rounded-xl cursor-pointer transition-all duration-200 ${task.id === selectedTaskId ? 'active' : ''}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold uppercase tracking-wider ${task.id === selectedTaskId ? 'text-violet-400' : 'text-slate-500'}">${t('ticket')} #${task.id.substring(0, 6)}</span>
                        <span class="text-[10px] ${task.id === selectedTaskId ? 'text-slate-400' : 'text-slate-600'}">${t('just_now')}</span>
                    </div>
                    <p class="text-sm font-medium line-clamp-2 leading-relaxed ${task.id === selectedTaskId ? 'text-white' : 'text-slate-400'}">
                        ${task.question}
                    </p>
                </div>
            `).join('');
        }

        function renderHistory() {
            const section = document.getElementById('history-section');
            const container = document.getElementById('history-list');
            const titleEl = document.getElementById('history-title');
            const toggleText = document.getElementById('history-toggle-text');
            const deleteBtn = document.getElementById('delete-history-btn');
            const selectAllBtn = document.getElementById('select-all-btn');
            const selectAllText = document.getElementById('select-all-text');
            const deleteBtnText = document.getElementById('delete-btn-text');

            if (history.length === 0) {
                section.classList.add('hidden');
                selectedHistoryIds.clear();
                return;
            }

            section.classList.remove('hidden');
            titleEl.innerText = t('history');
            toggleText.innerText = historyVisible ? t('history_hide') : t('history_show');
            
            // Update delete button visibility and text
            if (selectedHistoryIds.size > 0) {
                deleteBtn.classList.remove('hidden');
                selectAllBtn.classList.remove('hidden');
                deleteBtnText.innerText = `${t('delete_selected')} (${selectedHistoryIds.size})`;
            } else {
                deleteBtn.classList.add('hidden');
                selectAllBtn.classList.add('hidden');
            }
            
            // Update select all button text
            const allSelected = history.length > 0 && selectedHistoryIds.size === history.length;
            selectAllText.innerText = allSelected ? t('deselect_all') : t('select_all');
            
            if (!historyVisible) {
                container.classList.add('hidden');
            } else {
                container.classList.remove('hidden');
            }

            container.innerHTML = history.map(item => `
                <div class="sidebar-item p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-50 border border-transparent hover:border-gray-100 ${item.id === selectedHistoryId ? 'bg-gray-50 ring-1 ring-gray-200' : 'text-gray-500 opacity-70'} flex items-start gap-2">
                    <input type="checkbox" 
                           onclick="event.stopPropagation(); toggleHistorySelection('${item.id}')" 
                           ${selectedHistoryIds.has(item.id) ? 'checked' : ''}
                           class="mt-1 w-3 h-3 rounded border-gray-300 text-blue-500 focus:ring-blue-500 cursor-pointer flex-shrink-0">
                    <div onclick="selectHistoryItem('${item.id}')" class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-[10px] font-medium uppercase tracking-wider text-green-600">âœ“ ${t('completed')}</span>
                            <span class="text-[10px] text-gray-400">${formatTime(item.completed_at)}</span>
                        </div>
                        <p class="text-xs line-clamp-2 leading-relaxed text-gray-500">
                            ${item.question.substring(0, 80)}${item.question.length > 80 ? '...' : ''}
                        </p>
                    </div>
                </div>
            `).join('');
        }
        
        function toggleHistorySelection(id) {
            if (selectedHistoryIds.has(id)) {
                selectedHistoryIds.delete(id);
            } else {
                selectedHistoryIds.add(id);
            }
            renderHistory();
        }
        
        function toggleSelectAll() {
            const allSelected = history.length > 0 && selectedHistoryIds.size === history.length;
            if (allSelected) {
                selectedHistoryIds.clear();
            } else {
                history.forEach(item => selectedHistoryIds.add(item.id));
            }
            renderHistory();
        }
        
        async function deleteSelectedHistory() {
            if (selectedHistoryIds.size === 0) return;
            
            const idsToDelete = Array.from(selectedHistoryIds);
            
            try {
                await fetch('/api/history/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: idsToDelete })
                });
                
                // Remove deleted items from local state
                history = history.filter(h => !selectedHistoryIds.has(h.id));
                
                // Clear selection if viewing a deleted item
                if (selectedHistoryId && selectedHistoryIds.has(selectedHistoryId)) {
                    selectedHistoryId = null;
                    renderMain();
                }
                
                selectedHistoryIds.clear();
                renderHistory();
            } catch (e) {
                alert(t('alert_op_fail'));
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return t('just_now');
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h`;
            return `${diffDays}d`;
        }

        function renderMain() {
            const container = document.getElementById('main-view');

            // Show history item if selected
            if (selectedHistoryId) {
                const item = history.find(h => h.id === selectedHistoryId);
                if (item) {
                    container.innerHTML = `
                        <div class="w-full max-w-2xl animate-fade-in">
                            <div class="glass rounded-2xl shadow-xl overflow-hidden">
                                <div class="bg-green-50/50 border-b border-green-100 p-6">
                                    <div class="flex items-center space-x-2 mb-3">
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-600 uppercase tracking-wide">âœ“ ${t('completed')}</span>
                                        <span class="text-xs text-gray-400 font-mono">ID: ${item.id}</span>
                                    </div>
                                    <div class="markdown-content text-gray-800">${marked.parse(item.question)}</div>
                                </div>
                                <div class="p-6 bg-white/60">
                                    <h3 class="text-sm font-semibold text-gray-500 mb-2">Your Reply:</h3>
                                    <div class="bg-gray-50 rounded-lg p-4 text-gray-700">${item.answer || '(No reply)'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.scrollTop = 0;
                    return;
                }
            }

            if (!selectedTaskId) {
                container.innerHTML = `
                    <div id="empty-detail" class="text-center text-gray-400 animate-fade-in">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gray-50 rounded-full flex items-center justify-center">
                            <svg class="w-10 h-10 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                        </div>
                        <p class="text-xl font-medium text-gray-500">${t('all_done')}</p>
                        <p class="text-sm mt-2 opacity-60">${t('wait_ai')}</p>
                    </div>`;
                return;
            }

            const task = tasks.find(t => t.id === selectedTaskId);
            if (!task) return;

            const currentWrapper = container.querySelector('[data-active-task]');
            const isShowingSameTask = currentWrapper && currentWrapper.getAttribute('data-active-task') === selectedTaskId;

            const cachedImg = imageCache[task.id] || "";
            const currentText = textCache[task.id] !== undefined ? textCache[task.id] : (task.answer || '');
            const isImgHidden = cachedImg ? "" : "hidden";

            if (isShowingSameTask) {
                const previewContainer = document.getElementById('preview-container');
                const imagePreview = document.getElementById('image-preview');
                const uploadPlaceholder = document.getElementById('upload-placeholder');

                if (cachedImg) {
                    imagePreview.src = cachedImg;
                    previewContainer.classList.remove('hidden');
                    uploadPlaceholder.classList.add('hidden');
                } else {
                    previewContainer.classList.add('hidden');
                    uploadPlaceholder.classList.remove('hidden');
                }
                return;
            }

            container.innerHTML = `
                <div class="w-full max-w-2xl animate-fade-in" data-active-task="${task.id}">
                    <div class="glass rounded-2xl shadow-xl overflow-hidden">
                        <div class="bg-gray-50/50 border-b border-gray-100 p-6">
                            <div class="flex items-center space-x-2 mb-3">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-600 uppercase tracking-wide">${t('status_pending')}</span>
                                <span class="text-xs text-gray-400 font-mono">ID: ${task.id}</span>
                            </div>
                            <div class="markdown-content text-gray-800">${marked.parse(task.question)}</div>
                        </div>

                        <div class="p-6 space-y-6 bg-white/60">
                            <div class="relative">
                                <textarea id="answer-input" 
                                    oninput="textCache['${task.id}'] = this.value"
                                    onkeydown="if((event.ctrlKey || event.metaKey) && event.key === 'Enter') { submitTask('${task.id}'); }"
                                    class="w-full h-40 p-4 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none text-gray-700 placeholder-gray-400 text-base leading-relaxed shadow-sm hover:border-gray-300" 
                                    placeholder="${t('placeholder')}" autofocus></textarea>
                                <div class="absolute bottom-3 right-3 text-xs text-gray-400 pointer-events-none bg-white/80 px-2 py-1 rounded">${t('markdown_tip')}</div>
                            </div>

                            <div class="relative group">
                                <div class="border-2 border-dashed border-gray-200 rounded-xl p-6 text-center transition-all duration-200 hover:bg-blue-50/30 hover:border-blue-300 cursor-pointer" onclick="document.getElementById('file-input').click()">
                                    <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleImage(this.files[0])">
                                    
                                    <div id="upload-placeholder" class="${cachedImg ? 'hidden' : ''}">
                                        <svg class="w-10 h-10 mx-auto text-gray-300 group-hover:text-blue-500 transition-colors mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <p class="text-sm text-gray-500 font-medium group-hover:text-blue-600 transition-colors">${t('upload_img')}</p>
                                        <p class="text-xs text-gray-400 mt-1">${t('paste_tip')}</p>
                                    </div>

                                    <div id="preview-container" class="relative inline-block ${isImgHidden}">
                                        <img id="image-preview" src="${cachedImg}" class="max-h-64 rounded-lg shadow-md border border-gray-200">
                                        <button onclick="event.stopPropagation(); clearImage();" class="absolute -top-3 -right-3 bg-white text-red-500 rounded-full p-1.5 shadow-md hover:bg-red-50 border border-gray-100 transition-all transform hover:scale-110">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center space-x-4 pt-4 border-t border-gray-100">
                                <button onclick="dismissTask('${task.id}')" class="px-6 py-3 text-gray-500 hover:text-red-600 hover:bg-red-50 font-medium rounded-xl transition-all duration-200 text-sm">
                                    ${t('dismiss')}
                                </button>
                                <button onclick="submitTask('${task.id}')" class="flex-1 px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-all duration-200 transform hover:-translate-y-0.5 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex justify-center items-center gap-2 text-sm">
                                    <span>${t('send')}</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
            `;

            document.getElementById('answer-input').value = currentText;
            
            // Scroll to top when switching tasks
            container.scrollTop = 0;

            document.onpaste = (e) => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let item of items) {
                    if (item.type.indexOf("image") === 0) {
                        saveCurrentText();
                        handleImage(item.getAsFile());
                    }
                }
            };
        }

        function saveCurrentText() {
            if (selectedTaskId) {
                const input = document.getElementById('answer-input');
                if (input) textCache[selectedTaskId] = input.value;
            }
        }

        function handleImage(file) {
            if (!selectedTaskId || !file) return;
            saveCurrentText();
            const reader = new FileReader();
            reader.onload = (e) => {
                imageCache[selectedTaskId] = e.target.result;
                renderMain();
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            if (!selectedTaskId) return;
            saveCurrentText();
            delete imageCache[selectedTaskId];
            renderMain();
        }

        async function submitTask(id) {
            saveCurrentText();
            const answer = textCache[id] !== undefined ? textCache[id] : "";
            const img = imageCache[id];

            if (!answer && !img) {
                alert(t('alert_empty'));
                return;
            }

            try {
                await fetch('/api/reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, answer, image: img || null })
                });
                tasks = tasks.filter(t => t.id !== id);
                delete imageCache[id];
                delete textCache[id];
                if (selectedTaskId === id) selectedTaskId = null;
                renderSidebar();
                renderMain();
            } catch (e) {
                alert(t('alert_fail'));
            }
        }

        async function dismissTask(id) {
            const oldTasks = [...tasks];
            tasks = tasks.filter(t => t.id !== id);
            if (selectedTaskId === id) selectedTaskId = tasks.length > 0 ? tasks[0].id : null;
            renderSidebar();
            renderMain();

            try {
                await fetch(`/api/request/${id}`, { method: 'DELETE' });
                delete imageCache[id];
                delete textCache[id];
            } catch (e) {
                alert(t('alert_op_fail'));
                tasks = oldTasks;
                renderSidebar();
            }
        }

        applyLang();
        fetchUserInfo();  // è·å–ç”¨æˆ·ä¿¡æ¯
        setInterval(poll, 1500);
        setInterval(fetchHistory, 5000);  // Fetch history less frequently
        poll();
        fetchHistory();
    </script>
    <style>
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</body>

</html>