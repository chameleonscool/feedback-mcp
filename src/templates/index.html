<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Feedback Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .sidebar-item.active {
            background: linear-gradient(to right, #eff6ff, #ffffff);
            border-left: 4px solid #3b82f6;
        }

        /* Markdown Styles */
        .markdown-content {
            line-height: 1.6;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            font-weight: 600;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        .markdown-content h1 { font-size: 1.5em; }
        .markdown-content h2 { font-size: 1.25em; }
        .markdown-content h3 { font-size: 1.1em; }
        .markdown-content p { margin-bottom: 0.75em; }
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        .markdown-content li { margin-bottom: 0.25em; }
        .markdown-content code {
            background: #f1f5f9;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: ui-monospace, monospace;
        }
        .markdown-content pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 0.75em;
        }
        .markdown-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }
        .markdown-content blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1em;
            color: #64748b;
            margin-bottom: 0.75em;
        }
        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 0.75em;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #e2e8f0;
            padding: 0.5em;
            text-align: left;
        }
        .markdown-content th {
            background: #f8fafc;
            font-weight: 600;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-100 to-gray-200 text-gray-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-80 bg-white/80 backdrop-blur-xl border-r border-gray-200 flex flex-col shadow-xl z-10">
        <div class="p-6 border-b border-gray-100">
            <div class="flex justify-between items-center mb-4">
                <h1
                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                        </path>
                    </svg>
                    <span id="ui-title">AI Feedback</span>
                </h1>
                <button onclick="toggleLang()"
                    class="px-2 py-0.5 text-[10px] font-bold border border-gray-200 rounded hover:bg-gray-50 transition-colors uppercase tracking-wider text-gray-500"
                    id="lang-btn">
                    中文
                </button>
            </div>
            <div class="flex items-center space-x-2 mt-2">
                <span class="relative flex h-2.5 w-2.5">
                    <span id="status-ping"
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span id="status-dot" class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                </span>
                <span id="status-text" class="text-xs text-gray-500 font-medium">Service Connected</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-3 space-y-2">
            <!-- Pending Tasks -->
            <div id="task-list">
                <!-- Task items will be injected here -->
            </div>
            
            <!-- History Section -->
            <div id="history-section" class="hidden mt-4 pt-4 border-t border-gray-200">
                <div class="flex items-center justify-between mb-2 px-1">
                    <span id="history-title" class="text-xs font-semibold text-gray-400 uppercase tracking-wider">History</span>
                    <button onclick="toggleHistory()" class="text-[10px] text-gray-400 hover:text-blue-500" id="toggle-history-btn">
                        <span id="history-toggle-text">Hide</span>
                    </button>
                </div>
                <div id="history-list" class="space-y-2">
                    <!-- History items will be injected here -->
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-100 flex flex-col items-center gap-2">
            <button id="notify-btn" onclick="requestNotificationPermission()"
                class="text-xs text-gray-400 hover:text-blue-500 transition-colors flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                    </path>
                </svg>
                <span id="ui-notify-label">Notification:</span> <span id="notify-status">Checking...</span>
            </button>
            <div id="sw-status" class="text-[10px] text-gray-300">SW: Loading</div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative">
        <div
            class="absolute inset-0 bg-gradient-to-tr from-blue-50/50 via-white/30 to-purple-50/50 pointer-events-none">
        </div>

        <div class="flex-1 overflow-y-auto p-8 relative z-0 flex items-start justify-center" id="main-view">
            <!-- Detail View will be injected here -->
        </div>
    </main>

    <script>
        // --- i18n ---
        const translations = {
            en: {
                title: "AI Feedback",
                status_connected: "Service Connected",
                status_disconnected: "Disconnected (Retrying...)",
                no_tasks: "No pending tasks",
                notify_label: "Notification:",
                notify_checking: "Checking...",
                notify_granted: "On",
                notify_denied: "Off",
                notify_default: "Request",
                sw_active: "SW: Active",
                sw_loading: "SW: Loading",
                sw_failed: "SW: Failed",
                all_done: "All tasks completed",
                wait_ai: "Waiting for AI to ask questions...",
                no_task_selected: "No task selected",
                select_task_tip: "Select a task from the list to reply",
                ticket: "Ticket",
                just_now: "just now",
                placeholder: "Enter your reply... (Ctrl+Enter to send)",
                markdown_tip: "Supports Markdown | ⌘+Enter",
                upload_img: "Click to upload screenshot",
                paste_tip: "Or paste image directly",
                dismiss: "Dismiss",
                send: "Send Reply",
                alert_empty: "Please enter content or upload an image",
                alert_fail: "Send failed",
                alert_op_fail: "Operation failed",
                status_pending: "Pending",
                new_msg_notify: "New AI Question",
                history: "History",
                history_hide: "Hide",
                history_show: "Show",
                completed: "Completed"
            },
            zh: {
                title: "AI 协作反馈中心",
                status_connected: "服务连接正常",
                status_disconnected: "连接断开 (重试中...)",
                no_tasks: "暂无待处理任务",
                notify_label: "通知权限:",
                notify_checking: "检查中...",
                notify_granted: "已开启",
                notify_denied: "已禁用",
                notify_default: "点击请求",
                sw_active: "SW: 已激活",
                sw_loading: "SW: 未加载",
                sw_failed: "SW: 失败",
                all_done: "已完成所有任务",
                wait_ai: "请等待 AI 发起新的提问...",
                no_task_selected: "没有选中的任务",
                select_task_tip: "请从左侧列表选择一个任务进行回复",
                ticket: "任务",
                just_now: "刚刚",
                placeholder: "请输入您的回复... (Ctrl+Enter 发送)",
                markdown_tip: "支持 Markdown | ⌘+Enter",
                upload_img: "点击上传截图",
                paste_tip: "或直接粘贴图片到页面",
                dismiss: "忽略 (Dismiss)",
                send: "发送回复",
                alert_empty: "请输入内容或上传图片",
                alert_fail: "发送失败",
                alert_op_fail: "操作失败",
                status_pending: "处理中",
                new_msg_notify: "AI 新提问",
                history: "历史记录",
                history_hide: "隐藏",
                history_show: "显示",
                completed: "已完成"
            }
        };

        let currentLang = localStorage.getItem('lang') || 'en';

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function toggleLang() {
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            localStorage.setItem('lang', currentLang);
            applyLang();
            renderSidebar();
            renderMain();
        }

        function applyLang() {
            document.documentElement.lang = currentLang === 'en' ? 'en' : 'zh-CN';
            document.title = t('title');
            document.getElementById('ui-title').innerText = t('title');
            document.getElementById('ui-notify-label').innerText = t('notify_label');
            document.getElementById('lang-btn').innerText = currentLang === 'en' ? '中文' : 'English';

            // Update status text based on current state
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            if (statusDot.classList.contains('bg-green-500')) {
                statusText.innerText = t('status_connected');
            } else {
                statusText.innerText = t('status_disconnected');
            }

            updateNotifyStatus();
            updateSWStatus();
        }

        let tasks = [];
        let history = [];
        let historyVisible = true;
        let selectedTaskId = null;
        let selectedHistoryId = null;
        let imageCache = {};
        let textCache = {};

        // --- Notification ---
        function updateNotifyStatus() {
            const status = Notification.permission;
            const el = document.getElementById('notify-status');
            if (!el) return;

            if (status === 'granted') {
                el.innerText = t('notify_granted');
                el.className = 'text-green-500 font-bold';
            } else if (status === 'denied') {
                el.innerText = t('notify_denied');
                el.className = 'text-red-500 font-bold';
            } else {
                el.innerText = t('notify_default');
                el.className = '';
            }
        }

        function updateSWStatus() {
            const el = document.getElementById('sw-status');
            if (!el) return;
            if (swRegistration) {
                el.innerText = t('sw_active');
                el.className = 'text-[10px] text-green-400';
            } else {
                // If it's already failed, keep failed.
            }
        }

        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                updateNotifyStatus();
                if (permission === 'granted') {
                    new Notification(t('title'), { body: t('notify_granted') });
                }
            });
        }

        // --- Service Worker Registration ---
        let swRegistration = null;
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(reg => {
                swRegistration = reg;
                updateSWStatus();
            }).catch(err => {
                const el = document.getElementById('sw-status');
                if (el) {
                    el.innerText = t('sw_failed');
                    el.className = 'text-[10px] text-red-400';
                }
            });

            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data.type === 'SELECT_TASK') {
                    selectTask(event.data.id);
                }
            });
        }

        function sendNotification(id, msg) {
            if (Notification.permission === "granted") {
                if (swRegistration) {
                    swRegistration.showNotification(t('new_msg_notify'), {
                        body: msg,
                        tag: id,
                        icon: '/favicon.ico'
                    });
                } else {
                    const n = new Notification(t('new_msg_notify'), {
                        body: msg,
                        tag: id,
                        icon: '/favicon.ico'
                    });
                    n.onclick = function (e) {
                        e.preventDefault();
                        window.focus();
                        selectTask(id);
                    };
                }
            }
        }

        // --- API & State ---
        async function poll() {
            try {
                const response = await fetch('/api/poll');
                const newTasks = await response.json();

                const oldIds = new Set(tasks.map(t => t.id));
                newTasks.forEach(task => {
                    if (!oldIds.has(task.id)) {
                        sendNotification(task.id, task.question);
                    }
                });

                const isChanged = JSON.stringify(tasks.map(t => t.id)) !== JSON.stringify(newTasks.map(t => t.id));
                tasks = newTasks;

                if (tasks.length > 0) {
                    if (!selectedTaskId || !tasks.find(t => t.id === selectedTaskId)) {
                        const hash = window.location.hash.substring(1);
                        if (hash && tasks.find(t => t.id === hash)) {
                            selectedTaskId = hash;
                        } else {
                            if (!selectedTaskId) {
                                selectedTaskId = tasks[0].id;
                            }
                        }
                        renderMain();
                    }
                } else {
                    if (selectedTaskId !== null) {
                        saveCurrentText();
                        selectedTaskId = null;
                        renderMain();
                    }
                }

                if (isChanged) renderSidebar();
                document.getElementById('status-dot').classList.replace('bg-red-500', 'bg-green-500');
                document.getElementById('status-text').innerText = t('status_connected');

            } catch (e) {
                document.getElementById('status-dot').classList.replace('bg-green-500', 'bg-red-500');
                document.getElementById('status-text').innerText = t('status_disconnected');
            }
        }

        async function fetchHistory() {
            try {
                const response = await fetch('/api/history');
                const newHistory = await response.json();
                const isChanged = JSON.stringify(history.map(h => h.id)) !== JSON.stringify(newHistory.map(h => h.id));
                history = newHistory;
                if (isChanged) renderHistory();
            } catch (e) {
                // Silently fail - history is optional
            }
        }

        function selectTask(id) {
            if (selectedTaskId === id) return;
            saveCurrentText();
            selectedTaskId = id;
            selectedHistoryId = null;
            window.location.hash = id;
            renderSidebar();
            renderHistory();
            renderMain();
        }

        function selectHistoryItem(id) {
            if (selectedHistoryId === id) return;
            saveCurrentText();
            selectedHistoryId = id;
            selectedTaskId = null;
            window.location.hash = id;
            renderSidebar();
            renderHistory();
            renderMain();
        }

        function toggleHistory() {
            historyVisible = !historyVisible;
            const historyList = document.getElementById('history-list');
            const toggleText = document.getElementById('history-toggle-text');
            if (historyVisible) {
                historyList.classList.remove('hidden');
                toggleText.innerText = t('history_hide');
            } else {
                historyList.classList.add('hidden');
                toggleText.innerText = t('history_show');
            }
        }

        // --- Rendering ---
        function renderSidebar() {
            const container = document.getElementById('task-list');

            if (tasks.length === 0) {
                container.innerHTML = `<div class="text-center mt-10 text-gray-400 text-sm"><p>${t('no_tasks')}</p></div>`;
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div onclick="selectTask('${task.id}')" 
                     class="sidebar-item p-4 rounded-xl cursor-pointer transition-all duration-200 hover:bg-white hover:shadow-sm border border-transparent hover:border-gray-100 ${task.id === selectedTaskId ? 'active bg-white shadow-sm ring-1 ring-blue-100' : 'text-gray-600'}">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-bold uppercase tracking-wider ${task.id === selectedTaskId ? 'text-blue-600' : 'text-gray-400'}">${t('ticket')} #${task.id.substring(0, 6)}</span>
                        <span class="text-[10px] text-gray-400">${t('just_now')}</span>
                    </div>
                    <p class="text-sm font-medium line-clamp-2 leading-relaxed ${task.id === selectedTaskId ? 'text-gray-900' : 'text-gray-500'}">
                        ${task.question}
                    </p>
                </div>
            `).join('');
        }

        function renderHistory() {
            const section = document.getElementById('history-section');
            const container = document.getElementById('history-list');
            const titleEl = document.getElementById('history-title');
            const toggleText = document.getElementById('history-toggle-text');

            if (history.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            titleEl.innerText = t('history');
            toggleText.innerText = historyVisible ? t('history_hide') : t('history_show');
            
            if (!historyVisible) {
                container.classList.add('hidden');
            } else {
                container.classList.remove('hidden');
            }

            container.innerHTML = history.map(item => `
                <div onclick="selectHistoryItem('${item.id}')" 
                     class="sidebar-item p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-50 border border-transparent hover:border-gray-100 ${item.id === selectedHistoryId ? 'bg-gray-50 ring-1 ring-gray-200' : 'text-gray-500 opacity-70'}">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-medium uppercase tracking-wider text-green-600">✓ ${t('completed')}</span>
                        <span class="text-[10px] text-gray-400">${formatTime(item.completed_at)}</span>
                    </div>
                    <p class="text-xs line-clamp-2 leading-relaxed text-gray-500">
                        ${item.question.substring(0, 80)}${item.question.length > 80 ? '...' : ''}
                    </p>
                </div>
            `).join('');
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return t('just_now');
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h`;
            return `${diffDays}d`;
        }

        function renderMain() {
            const container = document.getElementById('main-view');

            // Show history item if selected
            if (selectedHistoryId) {
                const item = history.find(h => h.id === selectedHistoryId);
                if (item) {
                    container.innerHTML = `
                        <div class="w-full max-w-2xl animate-fade-in">
                            <div class="glass rounded-2xl shadow-xl overflow-hidden">
                                <div class="bg-green-50/50 border-b border-green-100 p-6">
                                    <div class="flex items-center space-x-2 mb-3">
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-600 uppercase tracking-wide">✓ ${t('completed')}</span>
                                        <span class="text-xs text-gray-400 font-mono">ID: ${item.id}</span>
                                    </div>
                                    <div class="markdown-content text-gray-800">${marked.parse(item.question)}</div>
                                </div>
                                <div class="p-6 bg-white/60">
                                    <h3 class="text-sm font-semibold text-gray-500 mb-2">Your Reply:</h3>
                                    <div class="bg-gray-50 rounded-lg p-4 text-gray-700">${item.answer || '(No reply)'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.scrollTop = 0;
                    return;
                }
            }

            if (!selectedTaskId) {
                container.innerHTML = `
                    <div id="empty-detail" class="text-center text-gray-400 animate-fade-in">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gray-50 rounded-full flex items-center justify-center">
                            <svg class="w-10 h-10 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                        </div>
                        <p class="text-xl font-medium text-gray-500">${t('all_done')}</p>
                        <p class="text-sm mt-2 opacity-60">${t('wait_ai')}</p>
                    </div>`;
                return;
            }

            const task = tasks.find(t => t.id === selectedTaskId);
            if (!task) return;

            const currentWrapper = container.querySelector('[data-active-task]');
            const isShowingSameTask = currentWrapper && currentWrapper.getAttribute('data-active-task') === selectedTaskId;

            const cachedImg = imageCache[task.id] || "";
            const currentText = textCache[task.id] !== undefined ? textCache[task.id] : (task.answer || '');
            const isImgHidden = cachedImg ? "" : "hidden";

            if (isShowingSameTask) {
                const previewContainer = document.getElementById('preview-container');
                const imagePreview = document.getElementById('image-preview');
                const uploadPlaceholder = document.getElementById('upload-placeholder');

                if (cachedImg) {
                    imagePreview.src = cachedImg;
                    previewContainer.classList.remove('hidden');
                    uploadPlaceholder.classList.add('hidden');
                } else {
                    previewContainer.classList.add('hidden');
                    uploadPlaceholder.classList.remove('hidden');
                }
                return;
            }

            container.innerHTML = `
                <div class="w-full max-w-2xl animate-fade-in" data-active-task="${task.id}">
                    <div class="glass rounded-2xl shadow-xl overflow-hidden">
                        <div class="bg-gray-50/50 border-b border-gray-100 p-6">
                            <div class="flex items-center space-x-2 mb-3">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-600 uppercase tracking-wide">${t('status_pending')}</span>
                                <span class="text-xs text-gray-400 font-mono">ID: ${task.id}</span>
                            </div>
                            <div class="markdown-content text-gray-800">${marked.parse(task.question)}</div>
                        </div>

                        <div class="p-6 space-y-6 bg-white/60">
                            <div class="relative">
                                <textarea id="answer-input" 
                                    oninput="textCache['${task.id}'] = this.value"
                                    onkeydown="if((event.ctrlKey || event.metaKey) && event.key === 'Enter') { submitTask('${task.id}'); }"
                                    class="w-full h-40 p-4 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none text-gray-700 placeholder-gray-400 text-base leading-relaxed shadow-sm hover:border-gray-300" 
                                    placeholder="${t('placeholder')}" autofocus></textarea>
                                <div class="absolute bottom-3 right-3 text-xs text-gray-400 pointer-events-none bg-white/80 px-2 py-1 rounded">${t('markdown_tip')}</div>
                            </div>

                            <div class="relative group">
                                <div class="border-2 border-dashed border-gray-200 rounded-xl p-6 text-center transition-all duration-200 hover:bg-blue-50/30 hover:border-blue-300 cursor-pointer" onclick="document.getElementById('file-input').click()">
                                    <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleImage(this.files[0])">
                                    
                                    <div id="upload-placeholder" class="${cachedImg ? 'hidden' : ''}">
                                        <svg class="w-10 h-10 mx-auto text-gray-300 group-hover:text-blue-500 transition-colors mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <p class="text-sm text-gray-500 font-medium group-hover:text-blue-600 transition-colors">${t('upload_img')}</p>
                                        <p class="text-xs text-gray-400 mt-1">${t('paste_tip')}</p>
                                    </div>

                                    <div id="preview-container" class="relative inline-block ${isImgHidden}">
                                        <img id="image-preview" src="${cachedImg}" class="max-h-64 rounded-lg shadow-md border border-gray-200">
                                        <button onclick="event.stopPropagation(); clearImage();" class="absolute -top-3 -right-3 bg-white text-red-500 rounded-full p-1.5 shadow-md hover:bg-red-50 border border-gray-100 transition-all transform hover:scale-110">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center space-x-4 pt-4 border-t border-gray-100">
                                <button onclick="dismissTask('${task.id}')" class="px-6 py-3 text-gray-500 hover:text-red-600 hover:bg-red-50 font-medium rounded-xl transition-all duration-200 text-sm">
                                    ${t('dismiss')}
                                </button>
                                <button onclick="submitTask('${task.id}')" class="flex-1 px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-all duration-200 transform hover:-translate-y-0.5 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex justify-center items-center gap-2 text-sm">
                                    <span>${t('send')}</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
            `;

            document.getElementById('answer-input').value = currentText;
            
            // Scroll to top when switching tasks
            container.scrollTop = 0;

            document.onpaste = (e) => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let item of items) {
                    if (item.type.indexOf("image") === 0) {
                        saveCurrentText();
                        handleImage(item.getAsFile());
                    }
                }
            };
        }

        function saveCurrentText() {
            if (selectedTaskId) {
                const input = document.getElementById('answer-input');
                if (input) textCache[selectedTaskId] = input.value;
            }
        }

        function handleImage(file) {
            if (!selectedTaskId || !file) return;
            saveCurrentText();
            const reader = new FileReader();
            reader.onload = (e) => {
                imageCache[selectedTaskId] = e.target.result;
                renderMain();
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            if (!selectedTaskId) return;
            saveCurrentText();
            delete imageCache[selectedTaskId];
            renderMain();
        }

        async function submitTask(id) {
            saveCurrentText();
            const answer = textCache[id] !== undefined ? textCache[id] : "";
            const img = imageCache[id];

            if (!answer && !img) {
                alert(t('alert_empty'));
                return;
            }

            try {
                await fetch('/api/reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, answer, image: img || null })
                });
                tasks = tasks.filter(t => t.id !== id);
                delete imageCache[id];
                delete textCache[id];
                if (selectedTaskId === id) selectedTaskId = null;
                renderSidebar();
                renderMain();
            } catch (e) {
                alert(t('alert_fail'));
            }
        }

        async function dismissTask(id) {
            const oldTasks = [...tasks];
            tasks = tasks.filter(t => t.id !== id);
            if (selectedTaskId === id) selectedTaskId = tasks.length > 0 ? tasks[0].id : null;
            renderSidebar();
            renderMain();

            try {
                await fetch(`/api/request/${id}`, { method: 'DELETE' });
                delete imageCache[id];
                delete textCache[id];
            } catch (e) {
                alert(t('alert_op_fail'));
                tasks = oldTasks;
                renderSidebar();
            }
        }

        applyLang();
        setInterval(poll, 1500);
        setInterval(fetchHistory, 5000);  // Fetch history less frequently
        poll();
        fetchHistory();
    </script>
    <style>
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</body>

</html>