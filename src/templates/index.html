<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Intent Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .sidebar-item.active {
            background: linear-gradient(to right, #eff6ff, #ffffff);
            border-left: 4px solid #3b82f6;
        }

        /* Markdown Styles */
        .markdown-content {
            line-height: 1.6;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            font-weight: 600;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        .markdown-content h1 { font-size: 1.5em; }
        .markdown-content h2 { font-size: 1.25em; }
        .markdown-content h3 { font-size: 1.1em; }
        .markdown-content p { margin-bottom: 0.75em; }
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5em;
            margin-bottom: 0.75em;
        }
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        .markdown-content li { margin-bottom: 0.25em; }
        .markdown-content code {
            background: #f1f5f9;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: ui-monospace, monospace;
        }
        .markdown-content pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 0.75em;
        }
        .markdown-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }
        .markdown-content blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1em;
            color: #64748b;
            margin-bottom: 0.75em;
        }
        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 0.75em;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #e2e8f0;
            padding: 0.5em;
            text-align: left;
        }
        .markdown-content th {
            background: #f8fafc;
            font-weight: 600;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-100 to-gray-200 text-gray-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-80 bg-white/80 backdrop-blur-xl border-r border-gray-200 flex flex-col shadow-xl z-10">
        <div class="p-6 border-b border-gray-100">
            <div class="flex justify-between items-center mb-4">
                <h1
                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                        </path>
                    </svg>
                    <span id="ui-title">AI Intent</span>
                </h1>
                <button onclick="toggleLang()"
                    class="px-2 py-0.5 text-[10px] font-bold border border-gray-200 rounded hover:bg-gray-50 transition-colors uppercase tracking-wider text-gray-500"
                    id="lang-btn">
                    中文
                </button>
            </div>
            <div class="flex items-center space-x-2 mt-2">
                <span class="relative flex h-2.5 w-2.5">
                    <span id="status-ping"
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span id="status-dot" class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                </span>
                <span id="status-text" class="text-xs text-gray-500 font-medium">Service Connected</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-3 space-y-2">
            <!-- Pending Tasks -->
            <div id="task-list">
                <!-- Task items will be injected here -->
            </div>
            
            <!-- History Section -->
            <div id="history-section" class="hidden mt-4 pt-4 border-t border-gray-200">
                <div class="flex items-center justify-between mb-2 px-1">
                    <span id="history-title" class="text-xs font-semibold text-gray-400 uppercase tracking-wider">History</span>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleSelectAll()" class="text-[10px] text-gray-400 hover:text-blue-500 hidden" id="select-all-btn">
                            <span id="select-all-text">All</span>
                        </button>
                        <button onclick="deleteSelectedHistory()" class="text-[10px] text-red-400 hover:text-red-600 hidden" id="delete-history-btn">
                            <span id="delete-btn-text">Delete</span>
                        </button>
                        <button onclick="toggleHistory()" class="text-[10px] text-gray-400 hover:text-blue-500" id="toggle-history-btn">
                            <span id="history-toggle-text">Hide</span>
                        </button>
                    </div>
                </div>
                <div id="history-list" class="space-y-2">
                    <!-- History items will be injected here -->
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-100 flex flex-col items-center gap-2">
            <!-- Feishu Mode Toggle -->
            <button onclick="openFeishuSettings()"
                class="text-xs text-gray-400 hover:text-blue-500 transition-colors flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                    </path>
                </svg>
                <span id="ui-feishu-label">Feishu:</span> <span id="feishu-status" class="text-gray-500">Off</span>
            </button>
            
            <button id="notify-btn" onclick="requestNotificationPermission()"
                class="text-xs text-gray-400 hover:text-blue-500 transition-colors flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                    </path>
                </svg>
                <span id="ui-notify-label">Notification:</span> <span id="notify-status">Checking...</span>
            </button>
            <div id="sw-status" class="text-[10px] text-gray-300">SW: Loading</div>
        </div>
    </aside>
    
    <!-- Feishu Settings Modal -->
    <div id="feishu-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden animate-fade-in">
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white" id="feishu-modal-title">Feishu Mode</h3>
                            <p class="text-xs text-white/70" id="feishu-modal-subtitle">Configure Feishu bot integration</p>
                        </div>
                    </div>
                    <button onclick="closeFeishuSettings()" class="text-white/70 hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <!-- SDK Status -->
                <div id="feishu-sdk-warning" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-700">
                    <span class="font-medium">⚠️</span> <span id="feishu-sdk-msg">lark_oapi not installed</span>
                </div>
                
                <!-- Enable Toggle -->
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium text-gray-700" id="feishu-enable-label">Enable Feishu Mode</label>
                    <button id="feishu-toggle" onclick="toggleFeishuEnabled()" 
                        class="relative w-12 h-6 rounded-full transition-colors bg-gray-200">
                        <span id="feishu-toggle-dot" class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-transform"></span>
                    </button>
                </div>
                
                <!-- Configuration Fields -->
                <div id="feishu-config-fields" class="space-y-3 opacity-50 pointer-events-none">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">App ID</label>
                        <div class="relative">
                            <input type="text" id="feishu-app-id" placeholder="cli_xxxxxxxxxx"
                                class="w-full px-3 py-2 pr-10 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                            <button type="button" onclick="toggleFeishuAppIdVisibility()"
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none"
                                title="显示/隐藏 App ID">
                                <svg id="feishu-appid-eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <svg id="feishu-appid-eye-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">App Secret</label>
                        <div class="relative">
                            <input type="password" id="feishu-app-secret" placeholder="••••••••••••"
                                class="w-full px-3 py-2 pr-10 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                            <button type="button" onclick="toggleFeishuSecretVisibility()"
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none"
                                title="显示/隐藏密码">
                                <svg id="feishu-secret-eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                <svg id="feishu-secret-eye-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Receive ID</label>
                        <input type="text" id="feishu-receive-id" placeholder="ou_xxxxxxxxxx or oc_xxxxxxxxxx"
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1">Receive ID Type</label>
                        <select id="feishu-receive-id-type"
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none bg-white">
                            <option value="open_id">Open ID (ou_xxx)</option>
                            <option value="user_id">User ID</option>
                            <option value="union_id">Union ID</option>
                            <option value="email">Email</option>
                            <option value="chat_id">Chat ID (oc_xxx)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Connection Status -->
                <div id="feishu-connection-status" class="hidden bg-green-50 border border-green-200 rounded-lg p-3 text-sm text-green-700">
                    <span class="font-medium">✓</span> <span id="feishu-connection-msg">Connected</span>
                </div>
                
                <!-- Actions -->
                <div class="flex gap-3 pt-2">
                    <button onclick="testFeishuConnection()" id="feishu-test-btn"
                        class="flex-1 px-4 py-2 border border-gray-200 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="feishu-test-text">Test Connection</span>
                    </button>
                    <button onclick="saveFeishuConfig()"
                        class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg text-sm font-medium hover:from-blue-700 hover:to-indigo-700 transition-colors">
                        <span id="feishu-save-text">Save</span>
                    </button>
                </div>
                
                <!-- Help Text -->
                <div class="text-xs text-gray-400 pt-2 border-t border-gray-100">
                    <p id="feishu-help-text">Create a Feishu bot app at <a href="https://open.feishu.cn" target="_blank" class="text-blue-500 hover:underline">open.feishu.cn</a> and enable "im:message" permissions.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative">
        <div
            class="absolute inset-0 bg-gradient-to-tr from-blue-50/50 via-white/30 to-purple-50/50 pointer-events-none">
        </div>

        <div class="flex-1 overflow-y-auto p-8 relative z-0 flex items-start justify-center" id="main-view">
            <!-- Detail View will be injected here -->
        </div>
    </main>

    <script>
        // --- i18n ---
        const translations = {
            en: {
                title: "AI Intent",
                status_connected: "Service Connected",
                status_disconnected: "Disconnected (Retrying...)",
                no_tasks: "No pending tasks",
                notify_label: "Notification:",
                notify_checking: "Checking...",
                notify_granted: "On",
                notify_denied: "Off",
                notify_default: "Request",
                sw_active: "SW: Active",
                sw_loading: "SW: Loading",
                sw_failed: "SW: Failed",
                all_done: "All tasks completed",
                wait_ai: "Waiting for AI to ask questions...",
                no_task_selected: "No task selected",
                select_task_tip: "Select a task from the list to reply",
                ticket: "Ticket",
                just_now: "just now",
                placeholder: "Enter your reply... (Ctrl+Enter to send)",
                markdown_tip: "Supports Markdown | ⌘+Enter",
                upload_img: "Click to upload screenshot",
                paste_tip: "Or paste image directly",
                dismiss: "Dismiss",
                send: "Send Reply",
                alert_empty: "Please enter content or upload an image",
                alert_fail: "Send failed",
                alert_op_fail: "Operation failed",
                status_pending: "Pending",
                new_msg_notify: "New AI Intent Request",
                history: "History",
                history_hide: "Hide",
                history_show: "Show",
                completed: "Completed",
                delete_selected: "Delete",
                select_all: "All",
                deselect_all: "None",
                // Feishu
                feishu_label: "Feishu:",
                feishu_on: "On",
                feishu_off: "Off",
                feishu_modal_title: "Feishu Mode",
                feishu_modal_subtitle: "Configure Feishu bot integration",
                feishu_enable_label: "Enable Feishu Mode",
                feishu_test: "Test Connection",
                feishu_save: "Save",
                feishu_help: "Create a Feishu bot app at open.feishu.cn and enable \"im:message\" permissions.",
                feishu_sdk_missing: "lark_oapi not installed. Run: pip install lark_oapi",
                feishu_connected: "WebSocket connected",
                feishu_disconnected: "Not connected",
                feishu_test_success: "Test message sent successfully!",
                feishu_test_fail: "Failed to send test message",
                feishu_save_success: "Configuration saved",
                feishu_save_fail: "Failed to save configuration"
            },
            zh: {
                title: "AI 意图采集中心",
                status_connected: "服务连接正常",
                status_disconnected: "连接断开 (重试中...)",
                no_tasks: "暂无待处理任务",
                notify_label: "通知权限:",
                notify_checking: "检查中...",
                notify_granted: "已开启",
                notify_denied: "已禁用",
                notify_default: "点击请求",
                sw_active: "SW: 已激活",
                sw_loading: "SW: 未加载",
                sw_failed: "SW: 失败",
                all_done: "已完成所有任务",
                wait_ai: "请等待 AI 发起新的提问...",
                no_task_selected: "没有选中的任务",
                select_task_tip: "请从左侧列表选择一个任务进行回复",
                ticket: "任务",
                just_now: "刚刚",
                placeholder: "请输入您的回复... (Ctrl+Enter 发送)",
                markdown_tip: "支持 Markdown | ⌘+Enter",
                upload_img: "点击上传截图",
                paste_tip: "或直接粘贴图片到页面",
                dismiss: "忽略 (Dismiss)",
                send: "发送回复",
                alert_empty: "请输入内容或上传图片",
                alert_fail: "发送失败",
                alert_op_fail: "操作失败",
                status_pending: "处理中",
                new_msg_notify: "AI 新意图请求",
                history: "历史记录",
                history_hide: "隐藏",
                history_show: "显示",
                completed: "已完成",
                delete_selected: "删除",
                select_all: "全选",
                deselect_all: "取消",
                // Feishu
                feishu_label: "飞书模式:",
                feishu_on: "已开启",
                feishu_off: "已关闭",
                feishu_modal_title: "飞书模式",
                feishu_modal_subtitle: "配置飞书机器人集成",
                feishu_enable_label: "启用飞书模式",
                feishu_test: "测试连接",
                feishu_save: "保存",
                feishu_help: "在 open.feishu.cn 创建飞书机器人应用，并开启 \"im:message\" 权限。",
                feishu_sdk_missing: "lark_oapi 未安装。请运行: pip install lark_oapi",
                feishu_connected: "WebSocket 已连接",
                feishu_disconnected: "未连接",
                feishu_test_success: "测试消息发送成功！",
                feishu_test_fail: "测试消息发送失败",
                feishu_save_success: "配置已保存",
                feishu_save_fail: "保存配置失败"
            }
        };

        let currentLang = localStorage.getItem('lang') || 'en';

        function t(key) {
            return translations[currentLang][key] || key;
        }

        function toggleLang() {
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            localStorage.setItem('lang', currentLang);
            applyLang();
            renderSidebar();
            renderMain();
        }

        function applyLang() {
            document.documentElement.lang = currentLang === 'en' ? 'en' : 'zh-CN';
            document.title = t('title');
            document.getElementById('ui-title').innerText = t('title');
            document.getElementById('ui-notify-label').innerText = t('notify_label');
            document.getElementById('ui-feishu-label').innerText = t('feishu_label');
            document.getElementById('lang-btn').innerText = currentLang === 'en' ? '中文' : 'English';

            // Update status text based on current state
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            if (statusDot.classList.contains('bg-green-500')) {
                statusText.innerText = t('status_connected');
            } else {
                statusText.innerText = t('status_disconnected');
            }

            updateNotifyStatus();
            updateSWStatus();
            updateFeishuStatus();
        }

        let tasks = [];
        let history = [];
        let historyVisible = true;
        let selectedTaskId = null;
        let selectedHistoryId = null;
        let imageCache = {};
        let textCache = {};
        let selectedHistoryIds = new Set();  // For multi-select delete

        // --- Notification ---
        function updateNotifyStatus() {
            const status = Notification.permission;
            const el = document.getElementById('notify-status');
            if (!el) return;

            if (status === 'granted') {
                el.innerText = t('notify_granted');
                el.className = 'text-green-500 font-bold';
            } else if (status === 'denied') {
                el.innerText = t('notify_denied');
                el.className = 'text-red-500 font-bold';
            } else {
                el.innerText = t('notify_default');
                el.className = '';
            }
        }

        function updateSWStatus() {
            const el = document.getElementById('sw-status');
            if (!el) return;
            if (swRegistration) {
                el.innerText = t('sw_active');
                el.className = 'text-[10px] text-green-400';
            } else {
                // If it's already failed, keep failed.
            }
        }

        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                updateNotifyStatus();
                if (permission === 'granted') {
                    new Notification(t('title'), { body: t('notify_granted') });
                }
            });
        }

        // --- Service Worker Registration ---
        let swRegistration = null;
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(reg => {
                swRegistration = reg;
                updateSWStatus();
            }).catch(err => {
                const el = document.getElementById('sw-status');
                if (el) {
                    el.innerText = t('sw_failed');
                    el.className = 'text-[10px] text-red-400';
                }
            });

            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data.type === 'SELECT_TASK') {
                    selectTask(event.data.id);
                }
            });
        }

        function sendNotification(id, msg) {
            if (Notification.permission === "granted") {
                if (swRegistration) {
                    swRegistration.showNotification(t('new_msg_notify'), {
                        body: msg,
                        tag: id,
                        icon: '/favicon.ico'
                    });
                } else {
                    const n = new Notification(t('new_msg_notify'), {
                        body: msg,
                        tag: id,
                        icon: '/favicon.ico'
                    });
                    n.onclick = function (e) {
                        e.preventDefault();
                        window.focus();
                        selectTask(id);
                    };
                }
            }
        }

        // --- API & State ---
        async function poll() {
            try {
                const response = await fetch('/api/poll');
                const newTasks = await response.json();

                const oldIds = new Set(tasks.map(t => t.id));
                newTasks.forEach(task => {
                    if (!oldIds.has(task.id)) {
                        sendNotification(task.id, task.question);
                    }
                });

                const isChanged = JSON.stringify(tasks.map(t => t.id)) !== JSON.stringify(newTasks.map(t => t.id));
                tasks = newTasks;

                if (tasks.length > 0) {
                    if (!selectedTaskId || !tasks.find(t => t.id === selectedTaskId)) {
                        const hash = window.location.hash.substring(1);
                        if (hash && tasks.find(t => t.id === hash)) {
                            selectedTaskId = hash;
                            selectedHistoryId = null;  // Clear history selection when auto-selecting task
                        } else {
                            if (!selectedTaskId && !selectedHistoryId) {
                                // Only auto-select first task if no history is selected
                                selectedTaskId = tasks[0].id;
                            }
                        }
                        if (selectedTaskId && !selectedHistoryId) {
                            renderMain();
                        }
                    }
                } else {
                    if (selectedTaskId !== null) {
                        saveCurrentText();
                        selectedTaskId = null;
                        renderMain();
                    }
                }

                if (isChanged) renderSidebar();
                document.getElementById('status-dot').classList.replace('bg-red-500', 'bg-green-500');
                document.getElementById('status-text').innerText = t('status_connected');

            } catch (e) {
                document.getElementById('status-dot').classList.replace('bg-green-500', 'bg-red-500');
                document.getElementById('status-text').innerText = t('status_disconnected');
            }
        }

        async function fetchHistory() {
            try {
                const response = await fetch('/api/history');
                const newHistory = await response.json();
                const isChanged = JSON.stringify(history.map(h => h.id)) !== JSON.stringify(newHistory.map(h => h.id));
                history = newHistory;
                if (isChanged) renderHistory();
            } catch (e) {
                // Silently fail - history is optional
            }
        }

        function selectTask(id) {
            if (selectedTaskId === id) return;
            saveCurrentText();
            selectedTaskId = id;
            selectedHistoryId = null;
            window.location.hash = id;
            renderSidebar();
            renderHistory();
            renderMain();
        }

        function selectHistoryItem(id) {
            if (selectedHistoryId === id) return;
            saveCurrentText();
            selectedHistoryId = id;
            selectedTaskId = null;
            window.location.hash = id;
            renderSidebar();
            renderHistory();
            renderMain();
        }

        function toggleHistory() {
            historyVisible = !historyVisible;
            const historyList = document.getElementById('history-list');
            const toggleText = document.getElementById('history-toggle-text');
            if (historyVisible) {
                historyList.classList.remove('hidden');
                toggleText.innerText = t('history_hide');
            } else {
                historyList.classList.add('hidden');
                toggleText.innerText = t('history_show');
            }
        }

        // --- Rendering ---
        function renderSidebar() {
            const container = document.getElementById('task-list');

            if (tasks.length === 0) {
                container.innerHTML = `<div class="text-center mt-10 text-gray-400 text-sm"><p>${t('no_tasks')}</p></div>`;
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div onclick="selectTask('${task.id}')" 
                     class="sidebar-item p-4 rounded-xl cursor-pointer transition-all duration-200 hover:bg-white hover:shadow-sm border border-transparent hover:border-gray-100 ${task.id === selectedTaskId ? 'active bg-white shadow-sm ring-1 ring-blue-100' : 'text-gray-600'}">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-bold uppercase tracking-wider ${task.id === selectedTaskId ? 'text-blue-600' : 'text-gray-400'}">${t('ticket')} #${task.id.substring(0, 6)}</span>
                        <span class="text-[10px] text-gray-400">${t('just_now')}</span>
                    </div>
                    <p class="text-sm font-medium line-clamp-2 leading-relaxed ${task.id === selectedTaskId ? 'text-gray-900' : 'text-gray-500'}">
                        ${task.question}
                    </p>
                </div>
            `).join('');
        }

        function renderHistory() {
            const section = document.getElementById('history-section');
            const container = document.getElementById('history-list');
            const titleEl = document.getElementById('history-title');
            const toggleText = document.getElementById('history-toggle-text');
            const deleteBtn = document.getElementById('delete-history-btn');
            const selectAllBtn = document.getElementById('select-all-btn');
            const selectAllText = document.getElementById('select-all-text');
            const deleteBtnText = document.getElementById('delete-btn-text');

            if (history.length === 0) {
                section.classList.add('hidden');
                selectedHistoryIds.clear();
                return;
            }

            section.classList.remove('hidden');
            titleEl.innerText = t('history');
            toggleText.innerText = historyVisible ? t('history_hide') : t('history_show');
            
            // Update delete button visibility and text
            if (selectedHistoryIds.size > 0) {
                deleteBtn.classList.remove('hidden');
                selectAllBtn.classList.remove('hidden');
                deleteBtnText.innerText = `${t('delete_selected')} (${selectedHistoryIds.size})`;
            } else {
                deleteBtn.classList.add('hidden');
                selectAllBtn.classList.add('hidden');
            }
            
            // Update select all button text
            const allSelected = history.length > 0 && selectedHistoryIds.size === history.length;
            selectAllText.innerText = allSelected ? t('deselect_all') : t('select_all');
            
            if (!historyVisible) {
                container.classList.add('hidden');
            } else {
                container.classList.remove('hidden');
            }

            container.innerHTML = history.map(item => `
                <div class="sidebar-item p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-50 border border-transparent hover:border-gray-100 ${item.id === selectedHistoryId ? 'bg-gray-50 ring-1 ring-gray-200' : 'text-gray-500 opacity-70'} flex items-start gap-2">
                    <input type="checkbox" 
                           onclick="event.stopPropagation(); toggleHistorySelection('${item.id}')" 
                           ${selectedHistoryIds.has(item.id) ? 'checked' : ''}
                           class="mt-1 w-3 h-3 rounded border-gray-300 text-blue-500 focus:ring-blue-500 cursor-pointer flex-shrink-0">
                    <div onclick="selectHistoryItem('${item.id}')" class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-[10px] font-medium uppercase tracking-wider text-green-600">✓ ${t('completed')}</span>
                            <span class="text-[10px] text-gray-400">${formatTime(item.completed_at)}</span>
                        </div>
                        <p class="text-xs line-clamp-2 leading-relaxed text-gray-500">
                            ${item.question.substring(0, 80)}${item.question.length > 80 ? '...' : ''}
                        </p>
                    </div>
                </div>
            `).join('');
        }
        
        function toggleHistorySelection(id) {
            if (selectedHistoryIds.has(id)) {
                selectedHistoryIds.delete(id);
            } else {
                selectedHistoryIds.add(id);
            }
            renderHistory();
        }
        
        function toggleSelectAll() {
            const allSelected = history.length > 0 && selectedHistoryIds.size === history.length;
            if (allSelected) {
                selectedHistoryIds.clear();
            } else {
                history.forEach(item => selectedHistoryIds.add(item.id));
            }
            renderHistory();
        }
        
        async function deleteSelectedHistory() {
            if (selectedHistoryIds.size === 0) return;
            
            const idsToDelete = Array.from(selectedHistoryIds);
            
            try {
                await fetch('/api/history/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: idsToDelete })
                });
                
                // Remove deleted items from local state
                history = history.filter(h => !selectedHistoryIds.has(h.id));
                
                // Clear selection if viewing a deleted item
                if (selectedHistoryId && selectedHistoryIds.has(selectedHistoryId)) {
                    selectedHistoryId = null;
                    renderMain();
                }
                
                selectedHistoryIds.clear();
                renderHistory();
            } catch (e) {
                alert(t('alert_op_fail'));
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return t('just_now');
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h`;
            return `${diffDays}d`;
        }

        function renderMain() {
            const container = document.getElementById('main-view');

            // Show history item if selected
            if (selectedHistoryId) {
                const item = history.find(h => h.id === selectedHistoryId);
                if (item) {
                    container.innerHTML = `
                        <div class="w-full max-w-2xl animate-fade-in">
                            <div class="glass rounded-2xl shadow-xl overflow-hidden">
                                <div class="bg-green-50/50 border-b border-green-100 p-6">
                                    <div class="flex items-center space-x-2 mb-3">
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-600 uppercase tracking-wide">✓ ${t('completed')}</span>
                                        <span class="text-xs text-gray-400 font-mono">ID: ${item.id}</span>
                                    </div>
                                    <div class="markdown-content text-gray-800">${marked.parse(item.question)}</div>
                                </div>
                                <div class="p-6 bg-white/60">
                                    <h3 class="text-sm font-semibold text-gray-500 mb-2">Your Reply:</h3>
                                    <div class="bg-gray-50 rounded-lg p-4 text-gray-700">${item.answer || '(No reply)'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.scrollTop = 0;
                    return;
                }
            }

            if (!selectedTaskId) {
                container.innerHTML = `
                    <div id="empty-detail" class="text-center text-gray-400 animate-fade-in">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gray-50 rounded-full flex items-center justify-center">
                            <svg class="w-10 h-10 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                        </div>
                        <p class="text-xl font-medium text-gray-500">${t('all_done')}</p>
                        <p class="text-sm mt-2 opacity-60">${t('wait_ai')}</p>
                    </div>`;
                return;
            }

            const task = tasks.find(t => t.id === selectedTaskId);
            if (!task) return;

            const currentWrapper = container.querySelector('[data-active-task]');
            const isShowingSameTask = currentWrapper && currentWrapper.getAttribute('data-active-task') === selectedTaskId;

            const cachedImg = imageCache[task.id] || "";
            const currentText = textCache[task.id] !== undefined ? textCache[task.id] : (task.answer || '');
            const isImgHidden = cachedImg ? "" : "hidden";

            if (isShowingSameTask) {
                const previewContainer = document.getElementById('preview-container');
                const imagePreview = document.getElementById('image-preview');
                const uploadPlaceholder = document.getElementById('upload-placeholder');

                if (cachedImg) {
                    imagePreview.src = cachedImg;
                    previewContainer.classList.remove('hidden');
                    uploadPlaceholder.classList.add('hidden');
                } else {
                    previewContainer.classList.add('hidden');
                    uploadPlaceholder.classList.remove('hidden');
                }
                return;
            }

            container.innerHTML = `
                <div class="w-full max-w-2xl animate-fade-in" data-active-task="${task.id}">
                    <div class="glass rounded-2xl shadow-xl overflow-hidden">
                        <div class="bg-gray-50/50 border-b border-gray-100 p-6">
                            <div class="flex items-center space-x-2 mb-3">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-600 uppercase tracking-wide">${t('status_pending')}</span>
                                <span class="text-xs text-gray-400 font-mono">ID: ${task.id}</span>
                            </div>
                            <div class="markdown-content text-gray-800">${marked.parse(task.question)}</div>
                        </div>

                        <div class="p-6 space-y-6 bg-white/60">
                            <div class="relative">
                                <textarea id="answer-input" 
                                    oninput="textCache['${task.id}'] = this.value"
                                    onkeydown="if((event.ctrlKey || event.metaKey) && event.key === 'Enter') { submitTask('${task.id}'); }"
                                    class="w-full h-40 p-4 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none text-gray-700 placeholder-gray-400 text-base leading-relaxed shadow-sm hover:border-gray-300" 
                                    placeholder="${t('placeholder')}" autofocus></textarea>
                                <div class="absolute bottom-3 right-3 text-xs text-gray-400 pointer-events-none bg-white/80 px-2 py-1 rounded">${t('markdown_tip')}</div>
                            </div>

                            <div class="relative group">
                                <div class="border-2 border-dashed border-gray-200 rounded-xl p-6 text-center transition-all duration-200 hover:bg-blue-50/30 hover:border-blue-300 cursor-pointer" onclick="document.getElementById('file-input').click()">
                                    <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleImage(this.files[0])">
                                    
                                    <div id="upload-placeholder" class="${cachedImg ? 'hidden' : ''}">
                                        <svg class="w-10 h-10 mx-auto text-gray-300 group-hover:text-blue-500 transition-colors mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <p class="text-sm text-gray-500 font-medium group-hover:text-blue-600 transition-colors">${t('upload_img')}</p>
                                        <p class="text-xs text-gray-400 mt-1">${t('paste_tip')}</p>
                                    </div>

                                    <div id="preview-container" class="relative inline-block ${isImgHidden}">
                                        <img id="image-preview" src="${cachedImg}" class="max-h-64 rounded-lg shadow-md border border-gray-200">
                                        <button onclick="event.stopPropagation(); clearImage();" class="absolute -top-3 -right-3 bg-white text-red-500 rounded-full p-1.5 shadow-md hover:bg-red-50 border border-gray-100 transition-all transform hover:scale-110">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center space-x-4 pt-4 border-t border-gray-100">
                                <button onclick="dismissTask('${task.id}')" class="px-6 py-3 text-gray-500 hover:text-red-600 hover:bg-red-50 font-medium rounded-xl transition-all duration-200 text-sm">
                                    ${t('dismiss')}
                                </button>
                                <button onclick="submitTask('${task.id}')" class="flex-1 px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-all duration-200 transform hover:-translate-y-0.5 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex justify-center items-center gap-2 text-sm">
                                    <span>${t('send')}</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
            `;

            document.getElementById('answer-input').value = currentText;
            
            // Scroll to top when switching tasks
            container.scrollTop = 0;

            document.onpaste = (e) => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let item of items) {
                    if (item.type.indexOf("image") === 0) {
                        saveCurrentText();
                        handleImage(item.getAsFile());
                    }
                }
            };
        }

        function saveCurrentText() {
            if (selectedTaskId) {
                const input = document.getElementById('answer-input');
                if (input) textCache[selectedTaskId] = input.value;
            }
        }

        function handleImage(file) {
            if (!selectedTaskId || !file) return;
            saveCurrentText();
            const reader = new FileReader();
            reader.onload = (e) => {
                imageCache[selectedTaskId] = e.target.result;
                renderMain();
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            if (!selectedTaskId) return;
            saveCurrentText();
            delete imageCache[selectedTaskId];
            renderMain();
        }

        async function submitTask(id) {
            saveCurrentText();
            const answer = textCache[id] !== undefined ? textCache[id] : "";
            const img = imageCache[id];

            if (!answer && !img) {
                alert(t('alert_empty'));
                return;
            }

            try {
                await fetch('/api/reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, answer, image: img || null })
                });
                tasks = tasks.filter(t => t.id !== id);
                delete imageCache[id];
                delete textCache[id];
                if (selectedTaskId === id) selectedTaskId = null;
                renderSidebar();
                renderMain();
            } catch (e) {
                alert(t('alert_fail'));
            }
        }

        async function dismissTask(id) {
            const oldTasks = [...tasks];
            tasks = tasks.filter(t => t.id !== id);
            if (selectedTaskId === id) selectedTaskId = tasks.length > 0 ? tasks[0].id : null;
            renderSidebar();
            renderMain();

            try {
                await fetch(`/api/request/${id}`, { method: 'DELETE' });
                delete imageCache[id];
                delete textCache[id];
            } catch (e) {
                alert(t('alert_op_fail'));
                tasks = oldTasks;
                renderSidebar();
            }
        }

        // --- Feishu Functions ---
        let feishuConfig = {
            enabled: false,
            app_id: '',
            receive_id: '',
            receive_id_type: 'open_id',
            available: false,
            connected: false
        };

        async function fetchFeishuConfig() {
            try {
                const response = await fetch('/api/feishu/config');
                feishuConfig = await response.json();
                updateFeishuStatus();
            } catch (e) {
                console.error('Failed to fetch Feishu config:', e);
            }
        }

        function updateFeishuStatus() {
            const statusEl = document.getElementById('feishu-status');
            if (feishuConfig.enabled && feishuConfig.connected) {
                statusEl.innerText = t('feishu_on');
                statusEl.className = 'text-green-500 font-bold';
            } else if (feishuConfig.enabled) {
                statusEl.innerText = t('feishu_on');
                statusEl.className = 'text-yellow-500 font-bold';
            } else {
                statusEl.innerText = t('feishu_off');
                statusEl.className = 'text-gray-500';
            }
        }

        async function openFeishuSettings() {
            const modal = document.getElementById('feishu-modal');
            modal.classList.remove('hidden');
            
            // Fetch latest config before showing modal
            await fetchFeishuConfig();
            
            // Update modal content with current config
            updateFeishuModal();
            
            // Update i18n
            document.getElementById('feishu-modal-title').innerText = t('feishu_modal_title');
            document.getElementById('feishu-modal-subtitle').innerText = t('feishu_modal_subtitle');
            document.getElementById('feishu-enable-label').innerText = t('feishu_enable_label');
            document.getElementById('feishu-test-text').innerText = t('feishu_test');
            document.getElementById('feishu-save-text').innerText = t('feishu_save');
            document.getElementById('feishu-help-text').innerHTML = t('feishu_help').replace('open.feishu.cn', '<a href="https://open.feishu.cn" target="_blank" class="text-blue-500 hover:underline">open.feishu.cn</a>');
        }

        function closeFeishuSettings() {
            const modal = document.getElementById('feishu-modal');
            modal.classList.add('hidden');
        }

        function updateFeishuModal() {
            // SDK warning
            const sdkWarning = document.getElementById('feishu-sdk-warning');
            if (!feishuConfig.available) {
                sdkWarning.classList.remove('hidden');
                document.getElementById('feishu-sdk-msg').innerText = t('feishu_sdk_missing');
            } else {
                sdkWarning.classList.add('hidden');
            }
            
            // Toggle state
            const toggle = document.getElementById('feishu-toggle');
            const toggleDot = document.getElementById('feishu-toggle-dot');
            const configFields = document.getElementById('feishu-config-fields');
            
            if (feishuConfig.enabled) {
                toggle.classList.remove('bg-gray-200');
                toggle.classList.add('bg-blue-500');
                toggleDot.classList.add('translate-x-6');
                configFields.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                toggle.classList.add('bg-gray-200');
                toggle.classList.remove('bg-blue-500');
                toggleDot.classList.remove('translate-x-6');
                configFields.classList.add('opacity-50', 'pointer-events-none');
            }
            
            // Connection status
            const connStatus = document.getElementById('feishu-connection-status');
            const connMsg = document.getElementById('feishu-connection-msg');
            if (feishuConfig.enabled && feishuConfig.connected) {
                connStatus.classList.remove('hidden');
                connMsg.innerText = t('feishu_connected');
            } else if (feishuConfig.enabled) {
                connStatus.classList.remove('hidden');
                connStatus.classList.remove('bg-green-50', 'border-green-200', 'text-green-700');
                connStatus.classList.add('bg-yellow-50', 'border-yellow-200', 'text-yellow-700');
                connMsg.innerText = t('feishu_disconnected');
            } else {
                connStatus.classList.add('hidden');
            }

            // Fill form fields (don't show full secrets by default)
            // Store full values but show masked versions
            const appIdInput = document.getElementById('feishu-app-id');
            // Always store the full app_id value
            appIdInput.dataset.fullValue = feishuConfig.app_id || '';
            // Mask app_id by default (show only first 8 chars + ...)
            if (feishuConfig.app_id && feishuConfig.app_id.length > 8) {
                appIdInput.type = 'password';
                appIdInput.value = feishuConfig.app_id;
                appIdInput.dataset.masked = 'true';
            } else {
                appIdInput.type = 'text';
                appIdInput.value = feishuConfig.app_id || '';
                appIdInput.dataset.masked = 'false';
            }

            document.getElementById('feishu-receive-id').value = feishuConfig.receive_id || '';
            document.getElementById('feishu-receive-id-type').value = feishuConfig.receive_id_type || 'open_id';
        }

        function toggleFeishuEnabled() {
            feishuConfig.enabled = !feishuConfig.enabled;
            updateFeishuModal();
        }

        function toggleFeishuAppIdVisibility() {
            const input = document.getElementById('feishu-app-id');
            const eyeIcon = document.getElementById('feishu-appid-eye-icon');
            const eyeOffIcon = document.getElementById('feishu-appid-eye-off-icon');

            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.classList.add('hidden');
                eyeOffIcon.classList.remove('hidden');
                input.dataset.masked = 'false';
            } else {
                input.type = 'password';
                eyeIcon.classList.remove('hidden');
                eyeOffIcon.classList.add('hidden');
                input.dataset.masked = 'true';
            }
        }

        function toggleFeishuSecretVisibility() {
            const input = document.getElementById('feishu-app-secret');
            const eyeIcon = document.getElementById('feishu-secret-eye-icon');
            const eyeOffIcon = document.getElementById('feishu-secret-eye-off-icon');

            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.classList.add('hidden');
                eyeOffIcon.classList.remove('hidden');
            } else {
                input.type = 'password';
                eyeIcon.classList.remove('hidden');
                eyeOffIcon.classList.add('hidden');
            }
        }

        async function saveFeishuConfig() {
            // Get App ID - use full value from dataset to avoid password masking issues
            const appIdInput = document.getElementById('feishu-app-id');
            const app_id = appIdInput.dataset.fullValue || appIdInput.value;

            const config = {
                enabled: feishuConfig.enabled,
                app_id: app_id,
                app_secret: document.getElementById('feishu-app-secret').value || undefined,
                receive_id: document.getElementById('feishu-receive-id').value,
                receive_id_type: document.getElementById('feishu-receive-id-type').value
            };

            // Remove undefined values
            Object.keys(config).forEach(key => config[key] === undefined && delete config[key]);

            try {

                const response = await fetch('/api/feishu/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Refresh config
                    await fetchFeishuConfig();
                    updateFeishuModal();
                    showToast(t('feishu_save_success'), 'success');
                } else {
                    showToast(result.message || t('feishu_save_fail'), 'error');
                }
            } catch (e) {
                showToast(t('feishu_save_fail'), 'error');
            }
        }

        async function testFeishuConnection() {
            const testBtn = document.getElementById('feishu-test-btn');
            testBtn.disabled = true;
            testBtn.innerText = '...';

            try {
                const response = await fetch('/api/feishu/test', { method: 'POST' });
                const result = await response.json();

                if (result.status === 'success') {
                    showToast(t('feishu_test_success'), 'success');
                } else {
                    // Build detailed error message
                    let errorMsg = result.message || t('feishu_test_fail');
                    if (result.code) {
                        errorMsg += ` (错误码: ${result.code})`;
                    }
                    if (result.help) {
                        errorMsg += `\n提示: ${result.help}`;
                    }
                    showToast(errorMsg, 'error');
                }
            } catch (e) {
                showToast(t('feishu_test_fail'), 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.innerText = t('feishu_test');
            }
        }

        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-sm font-medium z-50 animate-fade-in ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-gray-800 text-white'
            }`;
            toast.innerText = message;
            document.body.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close modal on background click
        document.getElementById('feishu-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFeishuSettings();
            }
        });

        applyLang();
        setInterval(poll, 1500);
        setInterval(fetchHistory, 5000);  // Fetch history less frequently
        setInterval(fetchFeishuConfig, 10000);  // Check Feishu status periodically
        poll();
        fetchHistory();
        fetchFeishuConfig();
    </script>
    <style>
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</body>

</html>